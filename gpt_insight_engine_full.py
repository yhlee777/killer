# -*- coding: utf-8 -*-
# gpt_insight_engine.py - GPT ê¸°ë°˜ ì¸ì‚¬ì´íŠ¸ ìƒì„± (ì‹¤ì „ ì¸ì‚¬ì´íŠ¸ ê°•í™” + ì‚¬ì¥ë‹˜ ë²„ì „)

import os
import json
from datetime import datetime
from openai import OpenAI

api_key = os.getenv('OPENAI_API_KEY')
if not api_key:
    raise ValueError("âš ï¸ OPENAI_API_KEY í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!")

client = OpenAI(api_key=api_key)


# ==================== ì‚¬ì¥ë‹˜ìš© ê°„ì†Œí™” ë¦¬í¬íŠ¸ ====================

def generate_simplified_report(json_result, target_store, target_reviews, competitors):
    """
    ì‚¬ì¥ë‹˜ìš© ê°„ì†Œí™” ë¦¬í¬íŠ¸ (A4 2-3ì¥)
    """
    timestamp = datetime.now().strftime('%Yë…„ %mì›” %dì¼')
    
    md = f"""# ğŸª {target_store['name']} - ê¼­ ì•Œì•„ì•¼ í•  ê²ƒ

**ë¶„ì„ì¼**: {timestamp} | **ë¦¬ë·°**: {len(target_reviews)}ê°œ | **ê²½ìŸì‚¬**: {len(competitors)}ê°œ

---

## ğŸ¯ ê¼­ ì•Œì•„ì•¼ í•  ê²ƒ TOP 3

"""
    
    # TOP 3 (ë²ˆí˜¸ + ì´ëª¨ì§€ + í•œ ì¤„)
    priorities = json_result.get('summary', {}).get('top_priorities', [])[:3]
    
    if not priorities:
        md += "âœ… í˜„ì¬ í° ë¬¸ì œ ì—†ìŒ\n\n"
    else:
        for i, priority in enumerate(priorities, 1):
            # ë³µì¡í•œ í‘œí˜„ ì œê±°
            simple = priority.replace('(2ì£¼ ë‚´ ì‹¤í–‰)', '').replace('(ì¦‰ì‹œ)', '').strip()
            md += f"{i}. {simple}\n"
    
    md += f"\nğŸ’¡ **í•œ ì¤„ í‰ê°€**: {json_result.get('summary', {}).get('overall_assessment', '')}\n\n"
    
    # ==================== 1. ê³ ì³ì•¼ í•  ê²ƒ ====================
    md += f"\n---\n\n## ğŸ”§ ê³ ì³ì•¼ í•  ê²ƒ (ê¸‰í•œ ìˆœ)\n\n"
    
    weaknesses = json_result.get('ìš°ë¦¬ì˜_ì•½ì ', [])
    
    if not weaknesses or (len(weaknesses) == 1 and weaknesses[0].get('aspect') == 'ì—†ìŒ'):
        md += f"âœ¨ **ì—†ìŠµë‹ˆë‹¤!** ê³ ê° ë§Œì¡±ë„ê°€ ë†’ìŠµë‹ˆë‹¤.\n\n"
    else:
        for i, weakness in enumerate(weaknesses[:3], 1):  # ìƒìœ„ 3ê°œë§Œ
            aspect = weakness.get('aspect', 'í•­ëª©')
            desc = weakness.get('description', '')
            
            # í†µê³„ ì œê±°, ì‰½ê²Œ í‘œí˜„
            md += f"### {i}. {aspect}\n\n"
            md += f"**ë¬¸ì œ**: {desc}\n\n"
            
            # ë¦¬ë·° 1ê°œë§Œ
            if weakness.get('sample_reviews'):
                review = weakness['sample_reviews'][0]
                # ë¦¬ë·° ë²ˆí˜¸ ì œê±°
                clean_review = review.replace('[ë¦¬ë·°#', '').split(']', 1)[-1].strip() if '[ë¦¬ë·°#' in review else review
                md += f"**ê³ ê° ì˜ê²¬**: \"{clean_review}\"\n\n"
            
            # í•´ê²°ì±… ê°„ë‹¨íˆ
            if weakness.get('action'):
                action = weakness['action']
                md += f"**í•´ê²°ì±…**: {action.get('how', '')}\n"
                md += f"**ë¹„ìš©**: {action.get('cost', 'ë¯¸ì •')} | **ê¸°ê°„**: {action.get('timeline', '2ì£¼')}\n\n"
    
    # ==================== 2. ì˜í•˜ê³  ìˆëŠ” ê²ƒ ====================
    md += f"---\n\n## âœ¨ ì˜í•˜ê³  ìˆëŠ” ê²ƒ\n\n"
    
    strengths = json_result.get('ìš°ë¦¬ì˜_ê°•ì ', [])
    
    if not strengths:
        md += f"(ë°ì´í„° ë¶€ì¡±)\n\n"
    else:
        for i, strength in enumerate(strengths[:3], 1):  # ìƒìœ„ 3ê°œë§Œ
            aspect = strength.get('aspect', 'í•­ëª©')
            desc = strength.get('description', '')
            
            md += f"### {i}. {aspect}\n\n"
            md += f"**ê°•ì **: {desc}\n\n"
            
            # ë§ˆì¼€íŒ… íŒë§Œ
            if strength.get('marketing_tip'):
                tip = strength['marketing_tip']
                md += f"ğŸ’¡ **í™œìš©ë²•**: {tip}\n\n"
    
    # ==================== 3. ê²½ìŸì‚¬ ë¹„êµ ====================
    md += f"---\n\n## ğŸ¥Š ê²½ìŸì‚¬ì™€ ë¹„êµí•˜ë©´?\n\n"
    
    # ìš°ë¦¬ê°€ ì´ê¸°ëŠ” ë¶€ë¶„
    comp_opps = json_result.get('ê²½ìŸì‚¬ì˜_ì•½ì _ìš°ë¦¬ì˜_ê¸°íšŒ', [])
    if comp_opps:
        md += f"### ğŸ‘ ìš°ë¦¬ê°€ ì´ê¸°ëŠ” ë¶€ë¶„\n\n"
        for opp in comp_opps[:2]:  # 2ê°œë§Œ
            aspect = opp.get('aspect', 'í•­ëª©')
            opportunity = opp.get('opportunity', '')
            md += f"- **{aspect}**: {opportunity}\n"
        md += "\n"
    
    # ë°°ì›Œì•¼ í•  ë¶€ë¶„
    comp_benchs = json_result.get('ê²½ìŸì‚¬ì˜_ê°•ì _ë°°ìš¸ì ', [])
    if comp_benchs:
        md += f"### ğŸ“š ê²½ìŸì‚¬ê°€ ì˜í•˜ëŠ” ê²ƒ (ë°°ìš¸ ì )\n\n"
        for bench in comp_benchs[:2]:  # 2ê°œë§Œ
            aspect = bench.get('aspect', 'í•­ëª©')
            action_plan = bench.get('action_plan', '')
            # ë„ˆë¬´ ê¸¸ë©´ ì¶•ì•½
            if len(action_plan) > 100:
                action_plan = action_plan[:100] + "..."
            md += f"- **{aspect}**: {action_plan}\n"
        md += "\n"
    
    # ==================== 4. ê²½ìŸì‚¬ ëª©ë¡ ====================
    md += f"---\n\n## ğŸ“Œ ë¹„êµí•œ ê°€ê²Œë“¤\n\n"
    for i, comp in enumerate(competitors[:5], 1):  # 5ê°œë§Œ
        # ê°„ë‹¨íˆ
        comp_name = comp.name.split(',')[0]  # ì¹´í…Œê³ ë¦¬ ì œê±°
        md += f"{i}. {comp_name} ({comp.district}, ë¦¬ë·° {comp.review_count}ê°œ)\n"
    
    # ==================== í‘¸í„° ====================
    md += f"""
---

## ğŸ“ ì°¸ê³ ì‚¬í•­

- ì´ ë¦¬í¬íŠ¸ëŠ” ìµœê·¼ 6ê°œì›” ë¦¬ë·°ë¥¼ ë¶„ì„í•œ ê²°ê³¼ì…ë‹ˆë‹¤
- ìƒì„¸í•œ í†µê³„ ë°ì´í„°ëŠ” ì•„ë˜ 'ë¶€ë¡'ì„ ì°¸ê³ í•˜ì„¸ìš”
- ë¬¸ì˜: ë¶„ì„ ì‹œìŠ¤í…œ ê°œë°œíŒ€
"""
    
    return md


class PromptTemplates:
    """í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ê´€ë¦¬ (ì‹¤ì „ ì¸ì‚¬ì´íŠ¸ ê°•í™”)"""
    
    @staticmethod
    def advanced_analysis(target_store, target_stats, comp_stats_aggregated, 
                         sample_our_reviews, sample_comp_reviews, statistical_comparison):
        """ê³ ê¸‰ ë¶„ì„ í”„ë¡¬í”„íŠ¸ (9ê°€ì§€ ê²€ì¦ëœ ì¸ì‚¬ì´íŠ¸ ê¸°ë°˜)"""
        
        # í†µê³„ ë¹„êµ í…ìŠ¤íŠ¸ (ì‹ ë¢° ë°°ì§€ ì¶”ê°€)
        def get_confidence_badge(stat):
            """ì‹ ë¢°ë„ ë°°ì§€ ë°˜í™˜"""
            # countê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ rate * ì˜ˆìƒ í‘œë³¸ ìˆ˜ë¡œ ì¶”ì •
            n_our = stat['our'].get('count', 0)
            n_comp = stat['comp'].get('count', 0)
            
            # countê°€ 0ì´ë©´ rateë¡œë¶€í„° ì¶”ì • (target_stats, comp_stats_aggregatedì˜ total_reviews ì‚¬ìš©)
            if n_our == 0 and stat['our']['rate'] > 0:
                n_our = int(stat['our']['rate'] * target_stats.get('total_reviews', 100))
            if n_comp == 0 and stat['comp']['rate'] > 0:
                n_comp = int(stat['comp']['rate'] * comp_stats_aggregated.get('total_reviews', 100))
            
            n_total = n_our + n_comp
            ci_width = stat['ci'][1] - stat['ci'][0]
            p_val = stat['p_value']
            
            if n_total >= 100 and ci_width < 0.15 and p_val < 0.05:
                return "ğŸŸ¢"  # n ì¶©ë¶„/CI ì¢ìŒ/ìœ ì˜
            elif p_val >= 0.05 and p_val <= 0.10:
                return "ğŸŸ¡"  # ê²½ê³„
            elif n_total < 50:
                return "âšªï¸"  # ì°¸ê³ (í‘œë³¸ ì ìŒ)
            else:
                return "ğŸŸ¢" if p_val < 0.05 else "âšªï¸"
        
        stats_section = ""
        if statistical_comparison:
            stats_section = "\n## ğŸ“Š 4ë‹¨ê³„ í†µê³„ ë¶„ì„\n\n"
            
            if statistical_comparison.get('ìš°ë¦¬ì˜_ì•½ì '):
                stats_section += "### ğŸ”¥ 1. ìš°ë¦¬ì˜ ìœ ì˜ë¯¸í•œ ì•½ì  (ì¦‰ì‹œ ê°œì„ )\n\n"
                for topic, stat in statistical_comparison['ìš°ë¦¬ì˜_ì•½ì '].items():
                    gap_sign = "+" if stat['gap'] > 0 else ""
                    badge = get_confidence_badge(stat)
                    
                    # n ê³„ì‚° (countê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ rate * total_reviewsë¡œ ì¶”ì •)
                    n_our = stat['our'].get('count', int(stat['our']['rate'] * target_stats.get('total_reviews', 100)))
                    n_comp = stat['comp'].get('count', int(stat['comp']['rate'] * comp_stats_aggregated.get('total_reviews', 100)))
                    
                    stats_section += f"**âš ï¸ {topic}** {badge}\n"
                    stats_section += f"- ìš°ë¦¬: {stat['our']['rate']*100:.1f}%(n={n_our}) vs ê²½ìŸì‚¬: {stat['comp']['rate']*100:.1f}%(n={n_comp})\n"
                    stats_section += f"- GAP: {gap_sign}{stat['gap']:.3f} [95% CI: {stat['ci'][0]:.3f} ~ {stat['ci'][1]:.3f}]; P={stat['p_value']:.3f}\n\n"
            
            if statistical_comparison.get('ìš°ë¦¬ì˜_ê°•ì '):
                stats_section += "### âœ… 2. ìš°ë¦¬ì˜ ìœ ì˜ë¯¸í•œ ê°•ì  (ìœ ì§€/í™•ëŒ€)\n\n"
                for topic, stat in statistical_comparison['ìš°ë¦¬ì˜_ê°•ì '].items():
                    gap_sign = "+" if stat['gap'] > 0 else ""
                    badge = get_confidence_badge(stat)
                    
                    # n ê³„ì‚° (countê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ rate * total_reviewsë¡œ ì¶”ì •)
                    n_our = stat['our'].get('count', int(stat['our']['rate'] * target_stats.get('total_reviews', 100)))
                    n_comp = stat['comp'].get('count', int(stat['comp']['rate'] * comp_stats_aggregated.get('total_reviews', 100)))
                    
                    stats_section += f"**âœ¨ {topic}** {badge}\n"
                    stats_section += f"- ìš°ë¦¬: {stat['our']['rate']*100:.1f}%(n={n_our}) vs ê²½ìŸì‚¬: {stat['comp']['rate']*100:.1f}%(n={n_comp})\n"
                    stats_section += f"- GAP: {gap_sign}{stat['gap']:.3f} [95% CI: {stat['ci'][0]:.3f} ~ {stat['ci'][1]:.3f}]; P={stat['p_value']:.3f}\n\n"
            
            if statistical_comparison.get('ê²½ìŸì‚¬ì˜_ì•½ì _ìš°ë¦¬ì˜_ê¸°íšŒ'):
                stats_section += "### ğŸ’¡ 3. ê²½ìŸì‚¬ì˜ ì•½ì  = ìš°ë¦¬ì˜ ì°¨ë³„í™” ê¸°íšŒ\n\n"
                for topic, stat in statistical_comparison['ê²½ìŸì‚¬ì˜_ì•½ì _ìš°ë¦¬ì˜_ê¸°íšŒ'].items():
                    stats_section += f"**ğŸ¯ {topic}**: {stat['interpretation']}\n"
                    stats_section += f"- ê¸°íšŒ: ë§ˆì¼€íŒ… í¬ì¸íŠ¸ë¡œ í™œìš©!\n\n"
            
            if statistical_comparison.get('ê²½ìŸì‚¬ì˜_ê°•ì _ë°°ìš¸ì '):
                stats_section += "### ğŸ“š 4. ê²½ìŸì‚¬ì˜ ê°•ì  = ë²¤ì¹˜ë§ˆí‚¹ ëŒ€ìƒ\n\n"
                for topic, stat in statistical_comparison['ê²½ìŸì‚¬ì˜_ê°•ì _ë°°ìš¸ì '].items():
                    stats_section += f"**ğŸ” {topic}**: {stat['interpretation']}\n"
                    stats_section += f"- ë°°ìš¸ ì : ì „ëµ ì—°êµ¬ í•„ìš”\n\n"
        
        # ìƒ˜í”Œ ë¦¬ë·° (ë²ˆí˜¸ ì¶”ê°€ - ê²€ì¦ìš©!)
        our_reviews_text = ""
        for idx, r in enumerate(sample_our_reviews[:70], 1):
            our_reviews_text += f"[ë¦¬ë·°#{idx}] {r['content'][:250]}\n"
        
        comp_reviews_text = {}
        for comp_name, reviews in sample_comp_reviews.items():
            comp_text = ""
            for idx, r in enumerate(reviews[:5], 1):  # 5ê°œë¡œ ì¶•ì†Œ
                comp_text += f"[ë¦¬ë·°#{idx}] {r['content'][:250]}\n"
            comp_reviews_text[comp_name] = comp_text
        
        # ğŸ” ë””ë²„ê¹…: ê²½ìŸì‚¬ ë¦¬ë·° í”„ë¡¬í”„íŠ¸ í¬í•¨ í™•ì¸
        total_comp_reviews = sum(len(reviews) for reviews in sample_comp_reviews.values())
        total_comp_text_length = sum(len(text) for text in comp_reviews_text.values())
        
        print(f"\n   ğŸ” ë””ë²„ê¹…: í”„ë¡¬í”„íŠ¸ ìƒì„± í™•ì¸")
        print(f"      â””â”€ ìš°ë¦¬ ë¦¬ë·°: {len(sample_our_reviews)}ê°œ")
        print(f"      â””â”€ ê²½ìŸì‚¬ ë¦¬ë·°: {total_comp_reviews}ê°œ")
        print(f"      â””â”€ ê²½ìŸì‚¬ í…ìŠ¤íŠ¸ ê¸¸ì´: {total_comp_text_length:,} ê¸€ì")
        
        if total_comp_reviews == 0:
            print(f"      âš ï¸  ê²½ê³ : ê²½ìŸì‚¬ ë¦¬ë·°ê°€ í”„ë¡¬í”„íŠ¸ì— í¬í•¨ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤!")
        elif total_comp_text_length == 0:
            print(f"      âš ï¸  ê²½ê³ : ê²½ìŸì‚¬ ë¦¬ë·° í…ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!")
        else:
            print(f"      âœ… í”„ë¡¬í”„íŠ¸ ìƒì„± ì™„ë£Œ")
        
        prompt = f"""# ğŸª {target_store['name']} ê²½ìŸì‚¬ ë¶„ì„ (ì‹¤ì „ ì¸ì‚¬ì´íŠ¸ ê°•í™”)

## ê¸°ë³¸ ì •ë³´
- **ì§€ì—­**: {target_store['district']}
- **ì—…ì¢…**: {target_store['industry']}
- **ìš°ë¦¬ ë¦¬ë·° ìˆ˜**: {target_stats['total_reviews']}ê°œ
- **ê²½ìŸì‚¬ ë¦¬ë·° ìˆ˜**: {comp_stats_aggregated['total_reviews']}ê°œ

{stats_section}

## ğŸ“ˆ í‚¤ì›Œë“œ í†µê³„

### ìš°ë¦¬ ê°€ê²Œ
- ë§›_ê¸ì •: {target_stats['keyword_counts'].get('ë§›_ê¸ì •', 0)}íšŒ | ë§›_ë¶€ì •: {target_stats['keyword_counts'].get('ë§›_ë¶€ì •', 0)}íšŒ
- ì„œë¹„ìŠ¤_ê¸ì •: {target_stats['keyword_counts'].get('ì„œë¹„ìŠ¤_ê¸ì •', 0)}íšŒ | ì„œë¹„ìŠ¤_ë¶€ì •: {target_stats['keyword_counts'].get('ì„œë¹„ìŠ¤_ë¶€ì •', 0)}íšŒ
- ë¶„ìœ„ê¸°_ê¸ì •: {target_stats['keyword_counts'].get('ë¶„ìœ„ê¸°_ê¸ì •', 0)}íšŒ | ë¶„ìœ„ê¸°_ë¶€ì •: {target_stats['keyword_counts'].get('ë¶„ìœ„ê¸°_ë¶€ì •', 0)}íšŒ
- ì¬ë°©ë¬¸_ê¸ì •: {target_stats['keyword_counts'].get('ì¬ë°©ë¬¸_ê¸ì •', 0)}íšŒ
- ëŒ€ê¸°_ì–¸ê¸‰: {target_stats['keyword_counts'].get('ëŒ€ê¸°_ì–¸ê¸‰', 0)}íšŒ (ë‚®ì„ìˆ˜ë¡ ì¢‹ìŒ!)

### ê²½ìŸì‚¬ í‰ê· 
- ë§›_ê¸ì •: {comp_stats_aggregated['keyword_counts'].get('ë§›_ê¸ì •', 0)}íšŒ | ë§›_ë¶€ì •: {comp_stats_aggregated['keyword_counts'].get('ë§›_ë¶€ì •', 0)}íšŒ
- ì„œë¹„ìŠ¤_ê¸ì •: {comp_stats_aggregated['keyword_counts'].get('ì„œë¹„ìŠ¤_ê¸ì •', 0)}íšŒ | ì„œë¹„ìŠ¤_ë¶€ì •: {comp_stats_aggregated['keyword_counts'].get('ì„œë¹„ìŠ¤_ë¶€ì •', 0)}íšŒ
- ë¶„ìœ„ê¸°_ê¸ì •: {comp_stats_aggregated['keyword_counts'].get('ë¶„ìœ„ê¸°_ê¸ì •', 0)}íšŒ | ë¶„ìœ„ê¸°_ë¶€ì •: {comp_stats_aggregated['keyword_counts'].get('ë¶„ìœ„ê¸°_ë¶€ì •', 0)}íšŒ
- ì¬ë°©ë¬¸_ê¸ì •: {comp_stats_aggregated['keyword_counts'].get('ì¬ë°©ë¬¸_ê¸ì •', 0)}íšŒ
- ëŒ€ê¸°_ì–¸ê¸‰: {comp_stats_aggregated['keyword_counts'].get('ëŒ€ê¸°_ì–¸ê¸‰', 0)}íšŒ

## ğŸ’¬ ìƒ˜í”Œ ë¦¬ë·° (ê²€ì¦ìš© - ë¦¬ë·° ë²ˆí˜¸ í¬í•¨!)

ğŸš¨ **CRITICAL**: ì•„ë˜ ë¦¬ë·° ëª©ë¡ë§Œ ì‚¬ìš©! ì—†ëŠ” ë‚´ìš© ì ˆëŒ€ ê¸ˆì§€!

âš ï¸ **ë¶„ì„ ìš°ì„ ìˆœìœ„**: ë¶€ì • ë¦¬ë·°(ë³„ì  1-2ì )ë¥¼ ë¨¼ì € ë¶„ì„í•˜ì„¸ìš”!

### ìš°ë¦¬ ê°€ê²Œ ë¦¬ë·° (70ê°œ ìƒ˜í”Œ - ë¶€ì • ë¦¬ë·° ìš°ì„  ì •ë ¬ë¨)
{our_reviews_text}

### ê²½ìŸì‚¬ ë¦¬ë·° (ê° 5ê°œ ìƒ˜í”Œ)
{chr(10).join([f"**{name}**:{chr(10)}{text}" for name, text in comp_reviews_text.items()])}

---

## ğŸ¯ ì—…ì¢…/ì§€ì—­ ê²½ìŸì—ì„œ í†µí•˜ëŠ” ê²€ì¦ëœ ì¸ì‚¬ì´íŠ¸ 9ê°€ì§€

ë‹¹ì‹ ì˜ ë¶„ì„ì€ ë°˜ë“œì‹œ ì•„ë˜ 9ê°€ì§€ í”„ë ˆì„ì›Œí¬ë¥¼ ë”°ë¼ì•¼ í•©ë‹ˆë‹¤:

### 1ï¸âƒ£ ëŒ€ê¸°(ì›¨ì´íŒ…) ì–¸ê¸‰ë¥ : ë‚®ìœ¼ë©´ ê³§ ê¸°íšŒ
- **ì‹œì‚¬ì **: ëŒ€ê¸° ì–¸ê¸‰ë¥ ì´ ê²½ìŸì‚¬ë³´ë‹¤ ë‚®ìœ¼ë©´ "ë¹ ë¥¸ ì…ì¥ = ì°¨ë³„í™” ë©”ì‹œì§€"ê°€ ë¨¹í˜
- **ë©”ì‹œì§€**: "ì§€ê¸ˆ ì˜¤ì‹œë©´ ë°”ë¡œ ì…ì¥ ğŸ’¨", "í‰ì¼ ì €ë… 10ë¶„ ì»·"
- **ì•¡ì…˜**: ë„¤ì´ë²„ í†¡ì±„ë„/ì¸ìŠ¤íƒ€ ìŠ¤í† ë¦¬ì— "ì‹¤ì‹œê°„ ìë¦¬ ì—¬ìœ " ê³ ì •í…œí”Œë¦¿
- **KPI**: í´ë¦­â†’ë°©ë¬¸ ì „í™˜ìœ¨, ì˜¤ê°€ë‹‰ ì €ì¥ìˆ˜

### 2ï¸âƒ£ 'ì¬ë°©ë¬¸ ì˜í–¥' ì‹œê·¸ë„: ì‘ì•„ë„ ê°•ë ¥
- **ì‹œì‚¬ì **: "ë˜ ì˜¬ê²Œìš”/ì¬ë°©ë¬¸" ë¬¸êµ¬ ë¹„ìœ¨ì´ ê²½ìŸì‚¬ ëŒ€ë¹„ ë†’ìœ¼ë©´ ì¶©ì„±ë„ ë£¨í”„ ì„¤ê³„ íƒ€ì´ë°
- **ì•¡ì…˜**: 2íšŒì°¨ ë°©ë¬¸ ì¿ í°(ì˜ìˆ˜ì¦ í•˜ë‹¨ QR), ì ë¦½ 2â†’5íšŒ ì—…ê·¸ë ˆì´ë“œ í˜œíƒ
- **KPI**: 30ì¼ ë‚´ 2íšŒ ë°©ë¬¸ë¥ , LTV

### 3ï¸âƒ£ ë§›ì˜ ë°©í–¥ì„±: "ë‹¨ë§›/ì§ ë§›/í–¥" ê°™ì€ ì·¨í–¥ ì¢Œí‘œ
- **ì‹œì‚¬ì **: "ë‹¬ë‹¤/ì‹±ê²ë‹¤/í–¥ì´ ê°•í•˜ë‹¤" ê°™ì€ ê·¹ì„± í‘œí˜„ì€ í¬ì§€ì…”ë‹ íŒíŠ¸
- **ì•¡ì…˜**: ëŒ€í‘œ ë©”ë‰´ 1-2ê°œëŠ” ë‹¹ë„Â·ì—¼ë„ ì˜µì…˜ ëª…ì‹œ("SWEET- / NORMAL / SWEET+")
- **KPI**: ì˜µì…˜ ì„ íƒ ë¶„í¬, ê´€ë ¨ ë¶ˆë§Œ ë¦¬ë·° ê°ì†Œìœ¨

### 4ï¸âƒ£ 'ì‹œê·¸ë‹ˆì²˜ ë‹¨ì¼í™”'ê°€ í•„ìš”í•œ ìˆœê°„
- **ì‹œì‚¬ì **: ë§› ê¸ì •ì€ ë„“ê²Œ í¼ì ¸ ìˆëŠ”ë° íŠ¹ì • ë©”ë‰´ì˜ ê³ ë°€ë„ ì°¬ì‚¬ê°€ ëª¨ì´ë©´ ê·¸ê±¸ ì „ë©´ ë°°ì¹˜
- **ì•¡ì…˜**: ë©”ë‰´íŒ ìƒë‹¨/ì¸ë„¤ì¼, í•´ì‹œíƒœê·¸ë¥¼ ì‹œê·¸ë‹ˆì²˜ 1ì¢…ìœ¼ë¡œ ëª°ë¹µ
- **KPI**: ì‹œê·¸ë‹ˆì²˜ ì ìœ ìœ¨, ê°ë‹¨ê°€ ìƒìŠ¹

### 5ï¸âƒ£ ì˜¨ë„/ì‹ê° í´ë ˆì„ì€ ì¦‰ì‹œ í•˜ë“œí”½ìŠ¤
- **ì‹œì‚¬ì **: "ë¯¸ì§€ê·¼/ëˆ…ëˆ…/íƒí•˜ë‹¤(ì»¤í”¼)" ê°™ì€ í”¼ë“œë°±ì€ ë¯¸ì„¸ê³µì • ê°œì„ ìœ¼ë¡œ ë°”ë¡œ êº¾ì„
- **ì•¡ì…˜**: ì¶”ì¶œ/êµ½ê¸° íƒ€ì„ìŠ¤íƒ¬í”„ ë£°(ì˜ˆ: 10ë¶„ ë‚´ ì œê³µ), í…Œì´ë¸”ë³„ ì˜¨ë„/ë¬¼ì„± ì²´í¬ë¦¬ìŠ¤íŠ¸
- **KPI**: ë™ì¼ í‚¤ì›Œë“œ ì¬ë°œë¥  50%â†“

### 6ï¸âƒ£ í”¼í¬íƒ€ì„ ì„œë¹„ìŠ¤ í¸ì°¨
- **ì‹œì‚¬ì **: "ë°”ì  ë•Œ ë¶ˆì¹œì ˆ/ëŒ€ê¸° ê¸¸ë‹¤"ê°€ ì£¼ë§/ì €ë…ì— ëª°ë¦¬ë©´ ì¸ë ¥/ë™ì„  ì´ìŠˆ
- **ì•¡ì…˜**: í”¼í¬íƒ€ì„ì— ì…€í”„ ì›Œí„°/í”½ì—… ì…°ë„ìš° ìŠ¤í…Œì´ì…˜ ì„¤ì¹˜, ìºì…” ë¶„ë¦¬
- **KPI**: í”¼í¬íƒ€ì„ ë¶ˆë§Œ ë¹„ì¤‘, ì²´ë¥˜ì‹œê°„

### 7ï¸âƒ£ ë¶„ìœ„ê¸°/ê³µê°„ í‚¤ì›Œë“œì˜ ëˆ ë˜ëŠ” ì“°ì„ìƒˆ
- **ì‹œì‚¬ì **: "ìì—°ê´‘/í¬í† ìŠ¤íŒŸ/ì¢Œì„ ê°„ê²©" ê°™ì€ ê¸ì •ì´ ë§ìœ¼ë©´ ì´¬ì˜ ìœ ë„ ë™ì„ ì´ ì´ìµ
- **ì•¡ì…˜**: í¬í† ìŠ¤íŒŸ 1ê³³ 'ë¸Œëœë“œ í”„ë ˆì´ë°'(ë¡œê³  ì‘ì€ ë„¤ì˜¨/ë²½)
- **KPI**: UGC(íƒœê·¸ëœ ì‚¬ì§„) ì£¼ë‹¹ ì¦ê°€

### 8ï¸âƒ£ ê°€ê²© ë¶ˆë§Œì´ "ê°€ì„±ë¹„"ê°€ ì•„ë‹ˆë¼ "êµ¬ì„±"ì¼ ë•Œ
- **ì‹œì‚¬ì **: 'ë¹„ì‹¸ë‹¤'ë³´ë‹¤ "ì–‘Â·êµ¬ì„± ëŒ€ë¹„ ë¹„ì‹¸ë‹¤"ë©´ ì‹¬ë¦¬ ì•µì»¤ ë¬¸ì œ
- **ì•¡ì…˜**: ì„¸íŠ¸/íŠ¸ë¦¬ì˜¤ êµ¬ì„±(ë©”ì¸+ì‚¬ì´ë“œ ì†Œí˜•+ìŒë£Œ ì†Œí˜•)ìœ¼ë¡œ ì•µì»¤ ê°€ê²© ì„¸íŒ…
- **KPI**: ì„¸íŠ¸ ë¯¹ìŠ¤ìœ¨, ê°€ê²© ë¶ˆë§Œ ì¬ë°œë¥ 

### 9ï¸âƒ£ ê²½ìŸì‚¬ ê°•ì  ë¹ ë¥´ê²Œ í¡ìˆ˜í•˜ëŠ” 'ë¼ì´íŠ¸ ë²¤ì¹˜'
- **ì‹œì‚¬ì **: ê²½ìŸì‚¬ ë¦¬ë·°ì— "ëª…í™•í•œ 1ê°€ì§€ ê°•ì (ì˜ˆ: ë§¤ìš´ë§› ë‹¨ê³„, ë¹„ê±´ ì˜µì…˜)" ë°˜ë³µë˜ë©´ ì €ë¹„ìš© ìƒ˜í”Œ ë„ì…
- **ì•¡ì…˜**: 2ì£¼ íŒŒì¼ëŸ¿(POP 1ì¥ + SNS 2í¬ìŠ¤íŠ¸) â†’ ë°˜ì‘ ì¢‹ìœ¼ë©´ ì •ì‹ í¸ì„±
- **KPI**: íŒŒì¼ëŸ¿ ê¸°ê°„ í•´ë‹¹ í‚¤ì›Œë“œ ì–¸ê¸‰ë¥ 

---

## ğŸ” CRITICAL - ë¦¬ë·° ì¸ìš© ê²€ì¦ í”„ë¡œì„¸ìŠ¤ (6ë‹¨ê³„ í•„ìˆ˜!)

ì•½ì ì„ ì‘ì„±í•˜ê¸° **ì „ì—**, ë°˜ë“œì‹œ ì•„ë˜ 6ë‹¨ê³„ë¥¼ ë”°ë¥´ì„¸ìš”:

### **STEP 1: ìƒ˜í”Œ ë¦¬ë·° ëª©ë¡ ë‹¤ì‹œ ì½ê¸°**
- ìœ„ "ìš°ë¦¬ ê°€ê²Œ ë¦¬ë·° (70ê°œ ìƒ˜í”Œ)" ì„¹ì…˜ì„ **ì²œì²œíˆ ë‹¤ì‹œ ì½ìœ¼ì„¸ìš”**
- ê° ë¦¬ë·°ì— [ë¦¬ë·°#N] ë²ˆí˜¸ê°€ ìˆìŠµë‹ˆë‹¤

### **STEP 2: í‚¤ì›Œë“œë¡œ ì°¾ê¸°**
- ì˜ˆ: "ì„œë¹„ìŠ¤" ì•½ì  ì‘ì„± ì‹œ â†’ "ë¶ˆì¹œì ˆ", "ì„œë¹„ìŠ¤", "ì§ì›" í‚¤ì›Œë“œ ê²€ìƒ‰
- ìƒ˜í”Œ ë¦¬ë·°ì—ì„œ í•´ë‹¹ í‚¤ì›Œë“œê°€ í¬í•¨ëœ ë¦¬ë·°ë¥¼ ì°¾ìœ¼ì„¸ìš”

### **STEP 3: ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ë¬¸ì¥ ì°¾ê¸°**
- âŒ ë¹„ìŠ·í•œ ë‚´ìš© (ê¸ˆì§€!)
- âŒ ì˜ì—­ (ê¸ˆì§€!)
- âœ… **ì •í™•íˆ ë˜‘ê°™ì€ ë¬¸ì¥ë§Œ** ì‚¬ìš© ê°€ëŠ¥

### **STEP 4: ë¦¬ë·° ë²ˆí˜¸ì™€ í•¨ê»˜ ì›ë¬¸ ê·¸ëŒ€ë¡œ ë³µì‚¬**
- "[ë¦¬ë·°#15] ì§ì›ë¶„ì´ ë¶ˆì¹œì ˆí•´ì„œ ê¸°ë¶„ì´ ì•ˆ ì¢‹ì•˜ì–´ìš”"
- ë¦¬ë·° ë²ˆí˜¸ [ë¦¬ë·°#N] ë°˜ë“œì‹œ í¬í•¨!

### **STEP 5: ìê¸° ê²€ì¦**
- ë‹¤ì‹œ í•œë²ˆ í™•ì¸: "ì´ ë¬¸ì¥ì´ ìƒ˜í”Œ ë¦¬ë·° ëª©ë¡ì— **ì •ë§** ìˆë‚˜?"
- **100% í™•ì‹ **í•  ìˆ˜ ìˆì„ ë•Œë§Œ ì‚¬ìš©
- **ì¡°ê¸ˆì´ë¼ë„ ë¶ˆí™•ì‹¤í•˜ë©´ â†’ í•´ë‹¹ ì•½ì  í•­ëª© ì™„ì „ ì‚­ì œ!**

### **STEP 6: ê°œìˆ˜ í™•ì¸ + ìŠ¤ì¼€ì¼ ë§ì¶”ê¸°**
- **ë¹„ìœ¨(ì–¸ê¸‰ë¥ ) ê¸°ë°˜ ë¹„êµ í•„ìˆ˜!**
- ë¶€ì • ë¦¬ë·° **0ê°œ** â†’ "ì „ë°˜ì ìœ¼ë¡œ ì–‘í˜¸" ì‘ì„±, ê²½ìŸì‚¬ ë¶„ì„ì— ì§‘ì¤‘
- ë¶€ì • ë¦¬ë·° **1-2ê°œ** â†’ ìˆëŠ” ë§Œí¼ë§Œ ì¸ìš©, ê³¼ì¥ ê¸ˆì§€
  - ì˜ˆ: "1ëª…ì˜ ê³ ê°ì´ ì„œë¹„ìŠ¤ ë¶ˆë§Œ ì–¸ê¸‰ (ì „ì²´ì˜ 1.4%)"
  - ë°˜ë“œì‹œ **ë¹„ìœ¨**ê³¼ **ì ˆëŒ€ìˆ˜** í•¨ê»˜ í‘œê¸°
- ë¶€ì • ë¦¬ë·° **3ê°œ ì´ìƒ** â†’ 3ê°œ ì´ìƒ ì¸ìš©, ëª…í™•í•œ ì•½ì 
  - ì˜ˆ: "5ëª…ì˜ ê³ ê°ì´ ê°€ê²© ë¶ˆë§Œ ì–¸ê¸‰ (ì „ì²´ì˜ 7.1%)"

---

## ğŸ¯ ìŠ¤ì¼€ì¼ ë§ì¶”ê¸° (CRITICAL!)

### ì‹ ë¢°ë„ ê¸°ì¤€
1. **ìµœì†Œ í‘œë³¸**: ì „ì²´ ë¦¬ë·° < 30ê°œ â†’ "ì°¸ê³ ìš©"ìœ¼ë¡œ ë‹¤ìš´ê·¸ë ˆì´ë“œ
2. **ë¹„ìœ¨ ê¸°ë°˜ ë¹„êµ**: ì ˆëŒ€ íšŸìˆ˜ê°€ ì•„ë‹ˆë¼ ì–¸ê¸‰ë¥ (%)ë¡œ ë¹„êµ
   - âœ… "ëŒ€ê¸° ì–¸ê¸‰ë¥  5% vs ê²½ìŸì‚¬ 15%"
   - âŒ "ëŒ€ê¸° ì–¸ê¸‰ 3íšŒ vs ê²½ìŸì‚¬ 8íšŒ" (í‘œë³¸ í¬ê¸° ë‹¤ë¥´ë©´ ë¬´ì˜ë¯¸)
3. **ì¦ê±°â†’ê²°ë¡  ì²´ì¸**: ê° ì£¼ì¥ ì˜†ì— (ì–¸ê¸‰ë¥ , GAP, ìƒ˜í”Œ ì¸ìš© 1-2ê°œ) í•„ìˆ˜

### ë¦¬í¬íŠ¸ ë¬¸ì¥ í…œí”Œë¦¿ (ê·¸ëŒ€ë¡œ ì‚¬ìš©!)
```
- ëŒ€ê¸°: "ìš°ë¦¬ ëŒ€ê¸° ì–¸ê¸‰ë¥  x% vs ê²½ìŸì‚¬ y%ë¡œ -Î”(y-x). ì‹¤ì œ ë¦¬ë·°: [ë¦¬ë·°#12] 'ì €ë…ì— ì˜ˆì•½ ì—†ì´ë„ ë°”ë¡œ ì…ì¥'. â†’ 'ì¦‰ì‹œ ì…ì¥' ë©”ì‹œì§€ ìš´ì˜ ì¶”ì²œ."

- ì¬ë°©ë¬¸: "ì¬ë°©ë¬¸ ì˜í–¥ ë¬¸êµ¬ x%, ê²½ìŸì‚¬ y% ëŒ€ë¹„ +Î”. ìƒ˜í”Œ: [ë¦¬ë·°#19] 'ë‹¤ìŒì— ë˜ ì˜¬ê²Œìš”'. â†’ 2íšŒì°¨ ì¿ í° ì¦‰ì‹œ ë„ì…."

- ë§›(ì·¨í–¥): "ë‹¨ë§› ì–¸ê¸‰ì˜ ì–‘ê·¹í™”. [ë¦¬ë·°#25] 'ëë§›ì´ ë‹¬ë‹¤(ë¶ˆí˜¸)' vs [ë¦¬ë·°#8] 'ë””ì €íŠ¸ ì°ë§›ì§‘'. â†’ ë‹¹ë„ ì˜µì…˜ í‘œê¸°ë¡œ ë¶„ê¸° í•´ê²°."
```

---

## ğŸ“‹ ë¶„ì„ ì§€ì‹œì‚¬í•­ (4ë‹¨ê³„ êµ¬ì¡° + 9ê°€ì§€ ì¸ì‚¬ì´íŠ¸ ì ìš©)

### ğŸ”¥ í•µì‹¬ ì›ì¹™
1. **í†µê³„ì  ìœ ì˜ì„± ê¸°ë°˜**: P < 0.05ì¸ í•­ëª©ë§Œ "í™•ì‹¤í•¨"ìœ¼ë¡œ í‘œì‹œ
2. **ìŠ¤ì¼€ì¼ ë§ì¶”ê¸°**: ë¹„ìœ¨(ì–¸ê¸‰ë¥ %)ë¡œ ë¹„êµ, ìµœì†Œ í‘œë³¸ nâ‰¥30
3. **í†µê³„ í‘œê¸° í˜•ì‹ í†µì¼**: 
   - âœ… "ìš°ë¦¬ X.X%(n=N1) vs ê²½ìŸì‚¬ Y.Y%(n=N2); GAP Â±Z.Z%p; 95% CI [L, U]; P=0.XX ğŸŸ¢"
   - ì‹ ë¢° ë°°ì§€: ğŸŸ¢(ì‹ ë¢°), ğŸŸ¡(ê²½ê³„), âšªï¸(ì°¸ê³ )
4. **ì§„ì‹¤ì„± ìš°ì„ **: 
   - **ë¶€ì • ë¦¬ë·° 0ê°œ** â†’ "ì „ë°˜ì ìœ¼ë¡œ ì–‘í˜¸" í‘œì‹œ, ê²½ìŸì‚¬ ë°ì´í„°ì— ì§‘ì¤‘
   - **ë¶€ì • ë¦¬ë·° 1~2ê°œ** â†’ ìˆëŠ” ê·¸ëŒ€ë¡œ ì–¸ê¸‰ + ë¹„ìœ¨ í‘œê¸° (ê³¼ì¥ ê¸ˆì§€)
   - **ë¶€ì • ë¦¬ë·° 3ê°œ ì´ìƒ** â†’ ì•½ì ìœ¼ë¡œ ë¦¬í¬íŠ¸ + ë¹„ìœ¨ í‘œê¸°
5. **TOP3ì™€ ì•½ì  ì„¹ì…˜ ì¼ê´€ì„±**:
   - TOP3ì— ì–¸ê¸‰ëœ í•­ëª©ì€ ë°˜ë“œì‹œ ì•½ì  ì„¹ì…˜ì— ì¡´ì¬í•´ì•¼ í•¨
   - ì•½ì ì´ ì—†ìœ¼ë©´ TOP3ì—ë„ ì•½ì  ê°œì„ ì„ ë„£ì§€ ë§ ê²ƒ
6. **9ê°€ì§€ ì¸ì‚¬ì´íŠ¸ í”„ë ˆì„ì›Œí¬ ì ìš©**: ëŒ€ê¸°/ì¬ë°©ë¬¸/ë§›ë°©í–¥/ì‹œê·¸ë‹ˆì²˜/ì˜¨ë„/í”¼í¬íƒ€ì„/ë¶„ìœ„ê¸°/ê°€ê²©/ë²¤ì¹˜
7. **ì‹¤í–‰ ê°€ëŠ¥ì„± í•„í„°**: ì‚¬ì¥ë‹˜ì´ 3ê°œì›” ë‚´ í•´ê²° ê°€ëŠ¥í•œ ê²ƒë§Œ
   - âœ… í¬í•¨: ë§›/ì„œë¹„ìŠ¤/ê°€ê²©/ì²­ê²°/ë©”ë‰´/ëŒ€ê¸°/ì¬ë°©ë¬¸/ì˜¨ë„/ìŒë£Œìƒíƒœ
   - âŒ ì œì™¸: ì£¼ì°¨/ê±´ë¬¼í¬ê¸°(ì¢ìŒ)/ìœ„ì¹˜/ì†ŒìŒ(ê±´ë¬¼êµ¬ì¡°)/ê³„ë‹¨/ì—˜ë¦¬ë² ì´í„°
8. **ëŒ€ê¸° í•´ì„**: ëŒ€ê¸° ì–¸ê¸‰ì´ **ì ì„ìˆ˜ë¡ ì¢‹ìŒ** (ë‚®ì„ìˆ˜ë¡ ê°•ì )
9. **ì¦ê±° ê¸°ë°˜**: ëª¨ë“  ì£¼ì¥ì— êµ¬ì²´ì  ìˆ˜ì¹˜(ì–¸ê¸‰ë¥ +GAP)ì™€ **ì‹¤ì œ ë¦¬ë·° ì›ë¬¸** ì¸ìš©

### ë¶„ì„ ìš”êµ¬ì‚¬í•­

1. **ìš°ë¦¬ì˜ ì•½ì ** (ğŸ”¥ ìµœìš°ì„ )
   - **9ê°€ì§€ ì¸ì‚¬ì´íŠ¸ ì¤‘ í•´ë‹¹ í•­ëª© ìš°ì„  ë¶„ì„**:
     - ì˜¨ë„/ì‹ê° â†’ ì¦‰ì‹œ í•˜ë“œí”½ìŠ¤
     - í”¼í¬íƒ€ì„ ì„œë¹„ìŠ¤ â†’ ì¸ë ¥/ë™ì„ 
     - ê°€ê²© êµ¬ì„± â†’ ì•µì»¤ ë¬¸ì œ
   - **CRITICAL - ë¶€ì • ë¦¬ë·° ì²˜ë¦¬ ê·œì¹™**:
     - **0ê°œ**: "ì „ë°˜ì ìœ¼ë¡œ ì–‘í˜¸" í‘œì‹œ, ê²½ìŸì‚¬ ë¶„ì„ì— ì§‘ì¤‘
     - **1~2ê°œ**: ìˆëŠ” ê·¸ëŒ€ë¡œ ì–¸ê¸‰ + ë¹„ìœ¨ (ì˜ˆ: "1ëª…, ì „ì²´ì˜ 1.4%")
     - **3ê°œ ì´ìƒ**: ì•½ì ìœ¼ë¡œ ëª…í™•íˆ ë¦¬í¬íŠ¸ + ë¹„ìœ¨
   - **ì‹¤í–‰ ê°€ëŠ¥ì„± í•„í„°** ì ìš©
   - P < 0.05 & GAP < -0.10 ì¸ í•­ëª© ìš°ì„ 
   - **ë°˜ë“œì‹œ ì‹¤ì œ ë¦¬ë·° ì›ë¬¸ ì¸ìš©** + **ë¦¬ë·° ë²ˆí˜¸ [ë¦¬ë·°#N] í•„ìˆ˜!**
   - ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥í•œ ê°œì„  ë°©ì•ˆ ì œì‹œ (2ì£¼ ëŸ¬ë‹ ê¸°ì¤€)

2. **ìš°ë¦¬ì˜ ê°•ì ** (âœ… ìœ ì§€/í™•ëŒ€)
   - **9ê°€ì§€ ì¸ì‚¬ì´íŠ¸ ì¤‘ í•´ë‹¹ í•­ëª© í™œìš©**:
     - ëŒ€ê¸° ë‚®ìŒ â†’ "ì¦‰ì‹œ ì…ì¥" ë©”ì‹œì§€
     - ì¬ë°©ë¬¸ ë†’ìŒ â†’ ì¶©ì„±ë„ ë£¨í”„
     - ë¶„ìœ„ê¸° ì¢‹ìŒ â†’ UGC ìœ ë„
   - P < 0.05 & GAP > +0.10 ì¸ í•­ëª©
   - ì‹¤ì œ ë¦¬ë·° 2ê°œ ì¸ìš© (ë¦¬ë·° ë²ˆí˜¸ í¬í•¨!)
   - ë§ˆì¼€íŒ… í™œìš© ë°©ì•ˆ (2ì£¼ ë‚´ ì‹¤í–‰ ê°€ëŠ¥)

3. **ê²½ìŸì‚¬ì˜ ì•½ì  = ìš°ë¦¬ì˜ ê¸°íšŒ** (ğŸ’¡ ì°¨ë³„í™”) **â† CRITICAL: ë°˜ë“œì‹œ ì‘ì„±!**
   - ê²½ìŸì‚¬ê°€ ì•½í•œ ë¶€ë¶„
   - ìš°ë¦¬ê°€ ìƒëŒ€ì ìœ¼ë¡œ ê°•í•œ ë¶€ë¶„
   - **ì¦‰ì‹œ ì…ì¥/ë¹ ë¥¸ ì„œë¹„ìŠ¤** ê°™ì€ ì°¨ë³„í™” ë©”ì‹œì§€ ì˜ˆì‹œ
   - **í†µê³„ í•„ìˆ˜**: ìš°ë¦¬ X.X%(n=N1) vs ê²½ìŸì‚¬ Y.Y%(n=N2); GAP; CI; Pê°’
   - **ê²½ìŸì‚¬ ë¦¬ë·°ë¥¼ ë°˜ë“œì‹œ ë¶„ì„í•˜ì—¬ ìµœì†Œ 1ê°œ ì´ìƒ ì‘ì„±**

4. **ê²½ìŸì‚¬ì˜ ê°•ì  = ë°°ìš¸ ì ** (ğŸ“š ë²¤ì¹˜ë§ˆí‚¹) **â† CRITICAL: ë°˜ë“œì‹œ ì‘ì„±!**
   - **ì¸ì‚¬ì´íŠ¸ 9ë²ˆ(ë¼ì´íŠ¸ ë²¤ì¹˜) ì ìš©**
   - ê²½ìŸì‚¬ê°€ ê°•í•œ ë¶€ë¶„
   - 2ì£¼ íŒŒì¼ëŸ¿ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥í•œ í•­ëª©
   - êµ¬ì²´ì  ë²¤ì¹˜ë§ˆí‚¹ ë°©ë²• (ë©”ë‰´ ìŠ¬ë¡¯/íŒë§¤ ë¹„ì¤‘ ëª©í‘œ/í…ŒìŠ¤íŠ¸ ê¸°ê°„)
   - **í†µê³„ í•„ìˆ˜**: ê²½ìŸì‚¬ X.X%(n=N1) vs ìš°ë¦¬ Y.Y%(n=N2); GAP; CI; Pê°’
   - **ê²½ìŸì‚¬ ë¦¬ë·°ë¥¼ ë°˜ë“œì‹œ ë¶„ì„í•˜ì—¬ ìµœì†Œ 1ê°œ ì´ìƒ ì‘ì„±**

**ğŸš¨ CRITICAL**: ê²½ìŸì‚¬ ë¶„ì„(3ë²ˆ, 4ë²ˆ)ì€ **í•„ìˆ˜**ì…ë‹ˆë‹¤. ê²½ìŸì‚¬ ë¦¬ë·°ê°€ ì œê³µë˜ì—ˆìœ¼ë¯€ë¡œ ë°˜ë“œì‹œ ë¶„ì„í•˜ì—¬ ì‘ì„±í•˜ì„¸ìš”. ë¹„ì›Œë‘ë©´ ì•ˆ ë©ë‹ˆë‹¤! ëª¨ë“  í†µê³„ì— n(í‘œë³¸ìˆ˜)ê³¼ ì‹ ë¢° ë°°ì§€ë¥¼ í¬í•¨í•˜ì„¸ìš”!

### ì¶œë ¥ í˜•ì‹ (JSON)

```json
{{
  "summary": {{
    "top_priorities": ["ìš°ì„ ê³¼ì œ 1 (2ì£¼ ë‚´ ì‹¤í–‰)", "ìš°ì„ ê³¼ì œ 2", "ìš°ì„ ê³¼ì œ 3"],
    "overall_assessment": "í•œ ì¤„ ìš”ì•½ (ì£¼ì¸ì¥ ì„¤ë“ìš©)",
    "biggest_opportunity": "ê°€ì¥ í° ê¸°íšŒ (ì°¨ë³„í™” í¬ì¸íŠ¸)"
  }},
  
  "ìš°ë¦¬ì˜_ì•½ì ": [
    {{
      "aspect": "ì˜¨ë„/ì‹ê°",
      "priority": 1,
      "statistical_evidence": "ìš°ë¦¬: 4.3%(n=69) vs ê²½ìŸì‚¬: 2.1%(n=711); GAP +2.2%p; 95% CI [0.1, 4.3]; P=0.04 ğŸŸ¢",
      "description": "3ëª…ì˜ ê³ ê°ì´ ìŒë£Œ ì˜¨ë„/ìŒì‹ ì‹ê° ë¶ˆë§Œ ì–¸ê¸‰",
      "insight_framework": "ì¸ì‚¬ì´íŠ¸#5: ì˜¨ë„/ì‹ê° í´ë ˆì„ì€ ì¦‰ì‹œ í•˜ë“œí”½ìŠ¤",
      "sample_reviews": [
        "[ë¦¬ë·°#15] ì»¤í”¼ê°€ ë¯¸ì§€ê·¼í•˜ê²Œ ë‚˜ì™”ì–´ìš”",
        "[ë¦¬ë·°#28] ë¹µì´ ëˆ…ëˆ…í–ˆìŠµë‹ˆë‹¤",
        "[ë¦¬ë·°#41] íŒŒìŠ¤íƒ€ê°€ ì‹ì–´ì„œ ë‚˜ì™”ì–´ìš”"
      ],
      "action": {{
        "title": "íƒ€ì„ìŠ¤íƒ¬í”„ ë£° ë„ì…",
        "how": "ì¶”ì¶œ/ì¡°ë¦¬ í›„ 10ë¶„ ë‚´ ì œê³µ ë£°, í…Œì´ë¸”ë³„ ì˜¨ë„ ì²´í¬ë¦¬ìŠ¤íŠ¸",
        "cost": "ë¬´ë£Œ (ìš´ì˜ ê°œì„ )",
        "difficulty": "ë‚®ìŒ",
        "timeline": "2ì£¼",
        "kpi": "ì˜¨ë„/ì‹ê° í‚¤ì›Œë“œ ì¬ë°œë¥  50%â†“"
      }}
    }}
  ],
  
  "ìš°ë¦¬ì˜_ê°•ì ": [
    {{
      "aspect": "ëŒ€ê¸° ì‹œê°„",
      "statistical_evidence": "ìš°ë¦¬: 0.0%(n=69) vs ê²½ìŸì‚¬: 1.6%(n=711); GAP -1.6%p; 95% CI [-3.0, -0.2]; P=0.03 ğŸŸ¢",
      "description": "ì›¨ì´íŒ…ì´ ì ì–´ ì¦‰ì‹œ ì…ì¥ ê°€ëŠ¥",
      "insight_framework": "ì¸ì‚¬ì´íŠ¸#1: ëŒ€ê¸° ë‚®ìŒ = ì°¨ë³„í™” ë©”ì‹œì§€",
      "sample_reviews": [
        "[ë¦¬ë·°#8] ì €ë…ì—ë„ ë°”ë¡œ ì…ì¥í•  ìˆ˜ ìˆì–´ì„œ ì¢‹ì•˜ì–´ìš”",
        "[ë¦¬ë·°#19] ì˜ˆì•½ ì—†ì´ ê°€ë„ ëŒ€ê¸° ì—†ì–´ìš”"
      ],
      "marketing_tip": "SNS ê³ ì • ë¬¸êµ¬: 'ì§€ê¸ˆ ì˜¤ì‹œë©´ ë°”ë¡œ ì…ì¥ ğŸ’¨ ì¢Œì„ ì—¬ìœ  ìˆì–´ìš” (ì˜¤ëŠ˜ 16:00 ì—…ë°ì´íŠ¸)'",
      "action": {{
        "title": "ì‹¤ì‹œê°„ ì…ì¥ ì•Œë¦¼",
        "how": "ì¸ìŠ¤íƒ€ ìŠ¤í† ë¦¬/ë„¤ì´ë²„ í†¡ì±„ë„ì— 'ìë¦¬ ì—¬ìœ ' í…œí”Œë¦¿",
        "timeline": "2ì£¼",
        "kpi": "í´ë¦­â†’ë°©ë¬¸ ì „í™˜ìœ¨, ì˜¤ê°€ë‹‰ ì €ì¥ìˆ˜"
      }}
    }}
  ],
  
  "ê²½ìŸì‚¬ì˜_ì•½ì _ìš°ë¦¬ì˜_ê¸°íšŒ": [
    {{
      "aspect": "ëŒ€ê¸° ì‹œê°„",
      "statistical_evidence": "ìš°ë¦¬: 0.0%(n=69) vs ê²½ìŸì‚¬: 1.6%(n=711); GAP -1.6%p; 95% CI [-3.0, -0.2]; P=0.03 ğŸŸ¢",
      "description": "ê²½ìŸì‚¬ëŠ” ëŒ€ê¸° ì–¸ê¸‰ì´ ìˆì§€ë§Œ ìš°ë¦¬ëŠ” ì¦‰ì‹œ ì…ì¥ ê°€ëŠ¥",
      "opportunity": "ë¹ ë¥¸ ì…ì¥ì„ ì°¨ë³„í™” í¬ì¸íŠ¸ë¡œ í™œìš©",
      "marketing_message": "ì§€ê¸ˆ ì˜¤ì‹œë©´ ë°”ë¡œ ì…ì¥ ğŸ’¨ ì›¨ì´íŒ… NO",
      "sample_comp_reviews": [
        "[ê²½ìŸì‚¬A ë¦¬ë·°#3] ì£¼ë§ ì €ë…ì— 1ì‹œê°„ ëŒ€ê¸°í–ˆì–´ìš”"
      ]
    }}
  ],
  
  "ê²½ìŸì‚¬ì˜_ê°•ì _ë°°ìš¸ì ": [
    {{
      "aspect": "ë§›ì˜ ë‹¤ì–‘ì„±",
      "statistical_evidence": "ê²½ìŸì‚¬: 8.5%(n=711) vs ìš°ë¦¬: 2.9%(n=69); GAP +5.6%p; 95% CI [0.8, 10.4]; P=0.02 ğŸŸ¢",
      "description": "ê²½ìŸì‚¬ëŠ” ë©”ë‰´ ë‹¤ì–‘ì„±ì— ëŒ€í•œ ê¸ì • ì–¸ê¸‰ì´ ë§ìŒ",
      "insight_framework": "ì¸ì‚¬ì´íŠ¸#9: ê²½ìŸì‚¬ ê°•ì  ë¹ ë¥´ê²Œ í¡ìˆ˜í•˜ëŠ” ë¼ì´íŠ¸ ë²¤ì¹˜",
      "benchmark": "ì‹œê·¸ë‹ˆì²˜/ì‹œì¦Œ/ë„ì „ ë©”ë‰´ 3ìŠ¬ë¡¯ êµ¬ì„±",
      "action_plan": "2ì£¼ íŒŒì¼ëŸ¿: ì‹ ê·œ 3ìŠ¬ë¡¯(ì‹œê·¸ë‹ˆì²˜ 25%, ì‹œì¦Œ 15%, ë„ì „ 10%), ê³ ê° ë°˜ì‘ ì¸¡ì • í›„ ì •ì‹ í¸ì„±",
      "sample_comp_reviews": [
        "[ê²½ìŸì‚¬B ë¦¬ë·°#5] ë©”ë‰´ê°€ ë‹¤ì–‘í•´ì„œ ë§¤ë²ˆ ë‹¤ë¥¸ ê±¸ ë¨¹ì–´ë´ìš”"
      ]
    }}
  ],
  
  "action_items": [
    {{
      "title": "2ì£¼ ì•¡ì…˜ 1",
      "category": "9ê°€ì§€ ì¸ì‚¬ì´íŠ¸ í”„ë ˆì„ì›Œí¬ ê¸°ë°˜",
      "why": "ì´ìœ  (ë°ì´í„° ê·¼ê±°)",
      "how": "ì‹¤í–‰ ë°©ë²• (êµ¬ì²´ì )",
      "cost": "ë¹„ìš© (ë¬´ë£Œ/ì €/ì¤‘/ê³ )",
      "difficulty": "ë‚œì´ë„ (ë‚®ìŒ/ë³´í†µ/ë†’ìŒ)",
      "timeline": "2ì£¼",
      "kpi": "ì¸¡ì • ê°€ëŠ¥í•œ KPI"
    }}
  ]
}}
```

**ğŸš¨ FINAL CHECK ğŸš¨**

JSONì„ ì œì¶œí•˜ê¸° ì „ì—, **ë§ˆì§€ë§‰ìœ¼ë¡œ í™•ì¸**í•˜ì„¸ìš”:

1. **TOP3ì™€ ì•½ì  ì„¹ì…˜ ì¼ê´€ì„±**: TOP3ì— ì–¸ê¸‰ëœ í•­ëª©ì´ ì•½ì  ì„¹ì…˜ì— ìˆë‚˜ìš”? ì•½ì ì´ ì—†ìœ¼ë©´ TOP3ì—ì„œ ì œì™¸í–ˆë‚˜ìš”?
2. **í†µê³„ í‘œê¸° í˜•ì‹**: ëª¨ë“  statistical_evidenceì— "ìš°ë¦¬ X.X%(n=N1) vs ê²½ìŸì‚¬ Y.Y%(n=N2); GAP Â±Z.Z%p; 95% CI [L, U]; P=0.XX ğŸŸ¢" í˜•ì‹ì„ ì‚¬ìš©í–ˆë‚˜ìš”?
3. **ê²½ìŸì‚¬ ì„¹ì…˜ í•„ìˆ˜ í•­ëª©**: "ê²½ìŸì‚¬ì˜_ì•½ì _ìš°ë¦¬ì˜_ê¸°íšŒ"ì™€ "ê²½ìŸì‚¬ì˜_ê°•ì _ë°°ìš¸ì "ì— ê°ê° ìµœì†Œ 1ê°œ ì´ìƒ í•­ëª©ì´ ìˆë‚˜ìš”?
4. **ì‹ ë¢° ë°°ì§€**: ëª¨ë“  í†µê³„ì— ğŸŸ¢/ğŸŸ¡/âšªï¸ ë°°ì§€ê°€ ìˆë‚˜ìš”?
5. **ë¦¬ë·° ë²ˆí˜¸**: ëª¨ë“  `sample_reviews`ì— **ë¦¬ë·° ë²ˆí˜¸([ë¦¬ë·°#N])**ê°€ ìˆë‚˜ìš”?
6. **ì›ë¬¸ ê·¸ëŒ€ë¡œ**: ëª¨ë“  `sample_reviews`ê°€ **ì›ë¬¸ ê·¸ëŒ€ë¡œ**ì¸ê°€ìš”?
7. **ë¹„ìœ¨ í‘œê¸°**: ë¶€ì • ë¦¬ë·° ê°œìˆ˜ì™€ **ë¹„ìœ¨(%)** ëª¨ë‘ í‘œê¸°í–ˆë‚˜ìš”?
8. **9ê°€ì§€ ì¸ì‚¬ì´íŠ¸**: **9ê°€ì§€ ì¸ì‚¬ì´íŠ¸ í”„ë ˆì„ì›Œí¬**ë¥¼ ì ìš©í–ˆë‚˜ìš”?
9. **ì‹¤í–‰ ê°€ëŠ¥ì„±**: ì‹¤í–‰ ë¶ˆê°€ëŠ¥í•œ ì•½ì (ì£¼ì°¨/ê±´ë¬¼/ìœ„ì¹˜)ì„ **ì œì™¸**í–ˆë‚˜ìš”?
10. **2ì£¼ ì•¡ì…˜**: ëª¨ë“  ì•¡ì…˜ì— **2ì£¼ íƒ€ì„ë¼ì¸ + ì¸¡ì • ê°€ëŠ¥í•œ KPI**ê°€ ìˆë‚˜ìš”?

**ëª¨ë‘ YESë©´ ì œì¶œ, í•˜ë‚˜ë¼ë„ NOë©´ ìˆ˜ì •!**

ë‹¹ì‹ ì˜ ë¶„ì„ì€ ì‚¬ì¥ë‹˜ì˜ ì‹¤ì œ ë¹„ì¦ˆë‹ˆìŠ¤ ê²°ì •ì— ì˜í–¥ì„ ì¤ë‹ˆë‹¤.
**ê±°ì§“ ì •ë³´ = ì‚¬ì—… ì‹¤íŒ¨**ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
100% í™•ì‹ í•  ìˆ˜ ìˆëŠ” ë‚´ìš©ë§Œ í¬í•¨í•˜ì„¸ìš”!
"""
        
        return prompt


class InsightAnalyzer:
    """GPT ê¸°ë°˜ ì¸ì‚¬ì´íŠ¸ ë¶„ì„ê¸°"""
    
    def __init__(self, model="gpt-4o", temperature=0.0, max_tokens=8000):
        self.model = model
        self.temperature = temperature
        self.max_tokens = max_tokens
    
    def analyze(self, prompt):
        """GPT ë¶„ì„ ì‹¤í–‰"""
        try:
            response = client.chat.completions.create(
                model=self.model,
                messages=[
                    {
                        "role": "system",
                        "content": """ë‹¹ì‹ ì€ ë°ì´í„° ê¸°ë°˜ ë¹„ì¦ˆë‹ˆìŠ¤ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

**ğŸš¨ ì ˆëŒ€ ê·œì¹™ ğŸš¨**:
1. ì‹¤ì œ ë¦¬ë·° ì›ë¬¸ë§Œ ì¸ìš©! ì ˆëŒ€ ì§€ì–´ë‚´ì§€ ë§ê²ƒ!
2. ì œê³µëœ ìƒ˜í”Œ ë¦¬ë·°ì— ì—†ëŠ” ë‚´ìš©ì€ ì–¸ê¸‰ ê¸ˆì§€!
3. ë¦¬ë·°ë¥¼ ìš”ì•½í•˜ê±°ë‚˜ ì˜ì—­í•˜ì§€ ë§ê³  ì›ë¬¸ ê·¸ëŒ€ë¡œ!
4. ë¦¬ë·° ë²ˆí˜¸ [ë¦¬ë·°#N] ë°˜ë“œì‹œ í¬í•¨!
5. ë¶ˆí™•ì‹¤í•˜ë©´ í•´ë‹¹ í•­ëª©ì„ ì œì™¸!
6. **ê²½ìŸì‚¬ ë¶„ì„(3ë²ˆ, 4ë²ˆ) í•„ìˆ˜ ì‘ì„±!**
7. **TOP3ì™€ ì•½ì  ì„¹ì…˜ ì¼ê´€ì„± í•„ìˆ˜!**

**í•µì‹¬ ì›ì¹™**:
1. í†µê³„ì  ìœ ì˜ì„±(P-value) í•„ìˆ˜ ê³ ë ¤
2. í†µê³„ í‘œê¸° í˜•ì‹ í†µì¼
3. ì‹ ë¢° ë°°ì§€ ì‚¬ìš©
4. ìŠ¤ì¼€ì¼ ë§ì¶”ê¸°
5. ì§„ì‹¤ì„± ìš°ì„ 
6. 9ê°€ì§€ ê²€ì¦ëœ ì¸ì‚¬ì´íŠ¸ í”„ë ˆì„ì›Œí¬ ì ìš©
7. ì‹¤í–‰ ê°€ëŠ¥ì„± í•„í„°
8. ëŒ€ê¸°ëŠ” "ë‚®ì„ìˆ˜ë¡ ì¢‹ìŒ"
9. ëª¨ë“  ì£¼ì¥ì— ì¦ê±° ì œì‹œ
10. ì‹¤ì œ ë¦¬ë·° ì›ë¬¸ë§Œ ì¸ìš©
11. ë¦¬ë·° ë²ˆí˜¸ í•„ìˆ˜
12. 2ì£¼ íƒ€ì„ë¼ì¸ + KPI
13. ê²½ìŸì‚¬ ë¶„ì„ ì ˆëŒ€ ìƒëµ ê¸ˆì§€!

**í†µê³„â†’ê²°ë¡  ì²´ì¸**:
- ê° ì£¼ì¥ ì˜†ì— (ìš°ë¦¬ X%(n=N1) vs ê²½ìŸì‚¬ Y%(n=N2); GAP; CI; P; ë°°ì§€; ìƒ˜í”Œ 1-2ê°œ) í•„ìˆ˜

**í• ë£¨ì‹œë„¤ì´ì…˜ ë°©ì§€**:
- ì œê³µëœ ë¦¬ë·° ëª©ë¡ì—ì„œë§Œ ì¸ìš©
- ì—†ëŠ” ë‚´ìš©ì€ ì ˆëŒ€ ë§Œë“¤ì§€ ë§ê²ƒ
- ì›ë¬¸ ê·¸ëŒ€ë¡œ ë³µì‚¬ë§Œ í—ˆìš©
- ë¦¬ë·° ë²ˆí˜¸ ì—†ìœ¼ë©´ ë¬´íš¨!

**ê²½ìŸì‚¬ ë¶„ì„ í•„ìˆ˜**:
- ê²½ìŸì‚¬ ë¦¬ë·°ê°€ ì œê³µë˜ì—ˆìœ¼ë¯€ë¡œ ë°˜ë“œì‹œ ë¶„ì„
- "ê²½ìŸì‚¬ì˜_ì•½ì _ìš°ë¦¬ì˜_ê¸°íšŒ" ì„¹ì…˜: ìµœì†Œ 1ê°œ ì´ìƒ, í†µê³„ í•„ìˆ˜
- "ê²½ìŸì‚¬ì˜_ê°•ì _ë°°ìš¸ì " ì„¹ì…˜: ìµœì†Œ 1ê°œ ì´ìƒ, í†µê³„ + 2ì£¼ íŒŒì¼ëŸ¿ ê³„íš í•„ìˆ˜
- ë¹„ì›Œë‘ê±°ë‚˜ ìƒëµí•˜ë©´ ì•ˆ ë¨!

**TOP3ì™€ ì•½ì  ì¼ê´€ì„±**:
- TOP3ì— ì•½ì  ê°œì„ ì´ ìˆìœ¼ë©´, ì•½ì  ì„¹ì…˜ì—ë„ ë°˜ë“œì‹œ í•´ë‹¹ í•­ëª© ì¡´ì¬
- ì•½ì ì´ ì—†ìœ¼ë©´ TOP3ì—ì„œ ì•½ì  ê°œì„ ì„ ë¹¼ê³  ê°•ì  í™•ëŒ€/ê²½ìŸì‚¬ ì°¨ë³„í™”ë¡œ êµ¬ì„±"""
                    },
                    {"role": "user", "content": prompt}
                ],
                temperature=self.temperature,
                max_tokens=self.max_tokens,
                response_format={"type": "json_object"}
            )
            
            return json.loads(response.choices[0].message.content)
            
        except Exception as e:
            print(f"âŒ GPT ë¶„ì„ ì‹¤íŒ¨: {e}")
            return None


def generate_insight_report(target_store, target_reviews, competitors, 
                           competitor_reviews, months_filter=6, 
                           analysis_type="advanced", statistical_comparison=None,
                           search_strategy=None,
                           simplified=True):  # ğŸ”¥ ìƒˆ ì˜µì…˜
    """ì¸ì‚¬ì´íŠ¸ ë¦¬í¬íŠ¸ ìƒì„± (ì‹¤ì „ ì¸ì‚¬ì´íŠ¸ ê°•í™”)"""
    from review_preprocessor import generate_review_stats, KEYWORD_DICT_BASE
    
    print(f"\n{'='*60}")
    print(f"ğŸ¤– STEP 5: GPT ì¸ì‚¬ì´íŠ¸ ì—”ì§„ (ì‹¤ì „ ì¸ì‚¬ì´íŠ¸ ê°•í™”)")
    print(f"{'='*60}")
    print(f"   ëª¨ë¸: gpt-4o (temperature=0.0)")
    print(f"   í”„ë ˆì„ì›Œí¬: 9ê°€ì§€ ê²€ì¦ëœ ì¸ì‚¬ì´íŠ¸")
    print(f"   ê²€ì¦: 6ë‹¨ê³„ + ë¦¬ë·° ë²ˆí˜¸ + ë¹„ìœ¨ í‘œê¸° í•„ìˆ˜")
    if search_strategy:
        print(f"   ê²€ìƒ‰ ì „ëµ: {search_strategy['name']} (Î²={search_strategy['beta']}, Î±={search_strategy['alpha']})")
    print(f"   ğŸ“¡ ë¶„ì„ ìš”ì²­ ì¤‘... (30-60ì´ˆ ì†Œìš”)")
    
    # í†µê³„ ìƒì„±
    target_stats = generate_review_stats(target_reviews, target_store['name'])
    
    # ê²½ìŸì‚¬ í†µê³„ ì§‘ê³„
    comp_stats_aggregated = {
        'total_reviews': 0,
        'keyword_counts': {k: 0 for k in KEYWORD_DICT_BASE.keys()}
    }
    
    # âœ… ìˆ˜ì •: CompetitorScore ê°ì²´ëŠ” ì†ì„±ìœ¼ë¡œ ì ‘ê·¼
    for comp in competitors:
        comp_revs = competitor_reviews.get(comp.place_id, [])
        if comp_revs:
            comp_stat = generate_review_stats(comp_revs, comp.name)
            comp_stats_aggregated['total_reviews'] += comp_stat['total_reviews']
            for key in KEYWORD_DICT_BASE.keys():
                comp_stats_aggregated['keyword_counts'][key] += comp_stat['keyword_counts'][key]
    
    # ìƒ˜í”Œ ë¦¬ë·° (ë¶€ì • ë¦¬ë·° ìš°ì„ )
    def sort_by_rating(review):
        """ë³„ì  ë‚®ì€ ìˆœ ì •ë ¬ (ë¶€ì • ë¦¬ë·° ìš°ì„ )"""
        rating = review.get('rating', 5)
        if rating == 0:
            rating = 5
        return rating
    
    target_reviews_sorted = sorted(target_reviews, key=sort_by_rating)
    sample_our_reviews = target_reviews_sorted[:70]
    
    sample_comp_reviews = {}
    # âœ… ìˆ˜ì •: CompetitorScore ê°ì²´ëŠ” ì†ì„±ìœ¼ë¡œ ì ‘ê·¼
    for comp in competitors:
        comp_revs = competitor_reviews.get(comp.place_id, [])
        if comp_revs:
            comp_revs_sorted = sorted(comp_revs, key=sort_by_rating)
            sample_comp_reviews[comp.name] = comp_revs_sorted[:5]  # 5ê°œë¡œ ì¶•ì†Œ
    
    # ğŸ” ë””ë²„ê¹…: ê²½ìŸì‚¬ ë¦¬ë·° ì „ë‹¬ í™•ì¸
    print(f"\n   ğŸ” ë””ë²„ê¹…: ê²½ìŸì‚¬ ë¦¬ë·° ìƒ˜í”Œ í™•ì¸")
    for comp_name, reviews in sample_comp_reviews.items():
        print(f"      â””â”€ {comp_name}: {len(reviews)}ê°œ ìƒ˜í”Œ")
        if reviews:
            print(f"         ì˜ˆì‹œ: {reviews[0]['content'][:50]}...")
    
    if not sample_comp_reviews:
        print(f"      âš ï¸  ê²½ìŸì‚¬ ë¦¬ë·° ìƒ˜í”Œì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!")
    else:
        print(f"   âœ… ì´ {len(sample_comp_reviews)}ê°œ ê²½ìŸì‚¬ ë¦¬ë·° ìƒ˜í”Œ ì¤€ë¹„ ì™„ë£Œ")
    
    # í”„ë¡¬í”„íŠ¸ ìƒì„±
    prompt = PromptTemplates.advanced_analysis(
        target_store=target_store,
        target_stats=target_stats,
        comp_stats_aggregated=comp_stats_aggregated,
        sample_our_reviews=sample_our_reviews,
        sample_comp_reviews=sample_comp_reviews,
        statistical_comparison=statistical_comparison
    )
    
    # GPT ë¶„ì„
    analyzer = InsightAnalyzer(model="gpt-4o", temperature=0.0, max_tokens=8000)
    result = analyzer.analyze(prompt)
    
    if not result:
        return "âŒ ë¶„ì„ ì‹¤íŒ¨"
    
    # ğŸ” ë””ë²„ê¹…: GPT ì‘ë‹µ í™•ì¸
    print(f"\n   ğŸ” ë””ë²„ê¹…: GPT ì‘ë‹µ í™•ì¸")
    
    # ê²½ìŸì‚¬ ì•½ì 
    if 'ê²½ìŸì‚¬ì˜_ì•½ì _ìš°ë¦¬ì˜_ê¸°íšŒ' in result:
        opp_list = result['ê²½ìŸì‚¬ì˜_ì•½ì _ìš°ë¦¬ì˜_ê¸°íšŒ']
        opp_count = len(opp_list) if isinstance(opp_list, list) else 0
        print(f"      â””â”€ ê²½ìŸì‚¬ ì•½ì  í•­ëª©: {opp_count}ê°œ")
        
        if opp_count == 0:
            print(f"         âš ï¸  ê²½ìŸì‚¬ ì•½ì  ì„¹ì…˜ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!")
    else:
        print(f"      âš ï¸  'ê²½ìŸì‚¬ì˜_ì•½ì _ìš°ë¦¬ì˜_ê¸°íšŒ' í‚¤ ì—†ìŒ")
    
    # ê²½ìŸì‚¬ ê°•ì 
    if 'ê²½ìŸì‚¬ì˜_ê°•ì _ë°°ìš¸ì ' in result:
        bench_list = result['ê²½ìŸì‚¬ì˜_ê°•ì _ë°°ìš¸ì ']
        bench_count = len(bench_list) if isinstance(bench_list, list) else 0
        print(f"      â””â”€ ê²½ìŸì‚¬ ê°•ì  í•­ëª©: {bench_count}ê°œ")
        
        if bench_count == 0:
            print(f"         âš ï¸  ê²½ìŸì‚¬ ê°•ì  ì„¹ì…˜ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!")
    else:
        print(f"      âš ï¸  'ê²½ìŸì‚¬ì˜_ê°•ì _ë°°ìš¸ì ' í‚¤ ì—†ìŒ")
    
    # ì „ì²´ JSON í‚¤ í™•ì¸
    print(f"      â””â”€ JSON í‚¤ ëª©ë¡: {list(result.keys())}")
    
    # ê²½ìŸì‚¬ ì„¹ì…˜ ëª¨ë‘ ë¹„ì–´ìˆìœ¼ë©´ ê²½ê³ 
    opp_empty = ('ê²½ìŸì‚¬ì˜_ì•½ì _ìš°ë¦¬ì˜_ê¸°íšŒ' not in result or 
                 len(result.get('ê²½ìŸì‚¬ì˜_ì•½ì _ìš°ë¦¬ì˜_ê¸°íšŒ', [])) == 0)
    bench_empty = ('ê²½ìŸì‚¬ì˜_ê°•ì _ë°°ìš¸ì ' not in result or 
                   len(result.get('ê²½ìŸì‚¬ì˜_ê°•ì _ë°°ìš¸ì ', [])) == 0)
    
    if opp_empty and bench_empty:
        print(f"\n   âš ï¸âš ï¸âš ï¸  ê²½ê³ : ê²½ìŸì‚¬ ë¶„ì„ ì„¹ì…˜ì´ ëª¨ë‘ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!")
        print(f"   ğŸ’¡ ê°€ëŠ¥í•œ ì›ì¸:")
        print(f"      1. GPTê°€ ê²½ìŸì‚¬ ë¦¬ë·°ë¥¼ ì¶©ë¶„íˆ ë¶„ì„í•˜ì§€ ëª»í•¨")
        print(f"      2. max_tokens ë¶€ì¡± (í˜„ì¬: 8000)")
        print(f"      3. í”„ë¡¬í”„íŠ¸ êµ¬ì¡° ë¬¸ì œ")
    
    # ğŸ”¥ ë‘ ê°€ì§€ ë²„ì „ ìƒì„±
    if simplified:
        # ì‚¬ì¥ë‹˜ ë²„ì „
        simple_report = generate_simplified_report(
            result, target_store, target_reviews, competitors
        )
        
        # ì „ë¬¸ê°€ ë²„ì „ (ë¶€ë¡)
        detailed_report = convert_to_markdown(
            result, target_store, target_reviews, competitors, search_strategy
        )
        
        # í•©ì¹˜ê¸°
        final_report = simple_report + "\n\n" + "="*60 + "\n\n"
        final_report += "# ğŸ“Š ë¶€ë¡: ìƒì„¸ ë¶„ì„ ë°ì´í„°\n\n"
        final_report += "(ì „ë¬¸ê°€ìš© - í†µê³„ì  ê·¼ê±° ë° ìƒì„¸ ë¶„ì„)\n\n"
        final_report += detailed_report
        
        print(f"   âœ… ì‚¬ì¥ë‹˜ìš© ê°„ì†Œí™” ë²„ì „ ìƒì„± ì™„ë£Œ!")
        return final_report
    else:
        # ì „ë¬¸ê°€ ë²„ì „ë§Œ
        return convert_to_markdown(
            result, target_store, target_reviews, competitors, search_strategy
        )


def convert_to_markdown(json_result, target_store, target_reviews, competitors, search_strategy=None):
    """JSON ê²°ê³¼ë¥¼ ë§ˆí¬ë‹¤ìš´ ë¦¬í¬íŠ¸ë¡œ ë³€í™˜"""
    
    timestamp = datetime.now().strftime('%Yë…„ %mì›” %dì¼ %H:%M')
    
    # ê²€ìƒ‰ ì „ëµ í…ìŠ¤íŠ¸ (ê°œì„ )
    strategy_text = ""
    strategy_detail = ""
    if search_strategy:
        strategy_name = search_strategy['name']
        beta = search_strategy['beta']
        alpha = search_strategy['alpha']
        
        strategy_text = f"\n**ê²€ìƒ‰ ì „ëµ**: {strategy_name} (ì—…ì¢… Î²={beta}, ì§€ì—­ Î±={alpha})"
        
        # ì „ëµ ì„¤ëª… ë°•ìŠ¤
        strategy_detail = f"""
---

## ğŸ¯ ê²½ìŸì‚¬ ì„ ì • ë¡œì§ (ì ìš©ëœ ì „ëµ: {strategy_name})

### ê°€ì¤‘ì¹˜ ì„¤ì •
- **ì—…ì¢… ê°€ì¤‘ì¹˜ (Î²)**: {beta} - ê°™ì€ ì—…ì¢…ì¼ìˆ˜ë¡ ë†’ì€ ì ìˆ˜
- **ì§€ì—­ ê°€ì¤‘ì¹˜ (Î±)**: {alpha} - ê°™ì€ ì§€ì—­ì¼ìˆ˜ë¡ ë†’ì€ ì ìˆ˜
- **ìµœì¢… ì ìˆ˜**: ì—…ì¢…ìœ ì‚¬ë„Ã—Î² + ì§€ì—­ì í•©ë„Ã—Î±

### í•„í„°ë§ ê·œì¹™
- ì—…ì¢…ìœ ì‚¬ë„ < 0.5 â†’ ì œì™¸ (ê±°ë¦¬ ë¬´ê´€)
- ì¥ë²½ ì¡´ì¬ (ê°•/ëŒ€ë¡œ/ì‡¼í•‘ëª°) â†’ ì§€ì—­ ì í•©ë„ Ã—0.8 íŒ¨ë„í‹°
- ë¦¬ë·° ìˆ˜ < 30ê°œ â†’ ì œì™¸ (ì‹ ë¢°ë„ ë¶€ì¡±)

### ëŒ€ì²´ ì „ëµ (ì°¸ê³ ìš©)
"""
        
        # í˜„ì¬ ì „ëµì´ ì•„ë‹Œ ë‹¤ë¥¸ ì „ëµë“¤ í‘œì‹œ
        all_strategies = [
            ("ì—…ì¢… ìš°ì„ ", 2.5, 0.5, "ê°™ì€ ì—…ì¢…ì„ ìµœìš°ì„ ìœ¼ë¡œ, ì§€ì—­ì€ ë„“ê²Œ ê²€ìƒ‰"),
            ("ì§€ì—­ ìš°ì„ ", 1.0, 1.5, "ê°™ì€ ì§€ì—­ì„ ìµœìš°ì„ ìœ¼ë¡œ, ì—…ì¢…ì€ ë‹¤ì–‘í•˜ê²Œ"),
            ("ê· í˜•", 1.8, 0.9, "ì—…ì¢…ê³¼ ì§€ì—­ì„ ëª¨ë‘ ê³ ë ¤ (ê¸°ë³¸ê°’)")
        ]
        
        for name, b, a, desc in all_strategies:
            if name != strategy_name:
                strategy_detail += f"- **{name}** (Î²={b}, Î±={a}): {desc}\n"
    
    md = f"""# ğŸª {target_store['name']} ê²½ìŸì‚¬ ë¶„ì„ ë¦¬í¬íŠ¸

**ìƒì„±ì¼ì‹œ**: {timestamp}
**ì§€ì—­**: {target_store['district']} | **ì—…ì¢…**: {target_store['industry']}
**ë¶„ì„ ë¦¬ë·°**: ìš°ë¦¬ ê°€ê²Œ {len(target_reviews)}ê°œ (ìµœê·¼ 6ê°œì›”){strategy_text}

---

## ğŸ“Š ë¶„ì„ ìš”ì•½

### ğŸ¯ ìš°ì„ ê³¼ì œ TOP3 (2ì£¼ ë‚´ ì‹¤í–‰)

"""
    
    for i, priority in enumerate(json_result.get('summary', {}).get('top_priorities', []), 1):
        md += f"{i}. {priority}\n"
    
    md += f"\n**ì¢…í•© í‰ê°€**: {json_result.get('summary', {}).get('overall_assessment', '')}\n"
    md += f"**ê°€ì¥ í° ê¸°íšŒ**: {json_result.get('summary', {}).get('biggest_opportunity', '')}\n"
    
    # 1. ìš°ë¦¬ì˜ ì•½ì 
    md += f"\n---\n\n## ğŸ”¥ 1. ìš°ë¦¬ì˜ ìœ ì˜ë¯¸í•œ ì•½ì  (ì¦‰ì‹œ ê°œì„ )\n\n"
    
    weaknesses = json_result.get('ìš°ë¦¬ì˜_ì•½ì ', [])
    
    if not weaknesses or (len(weaknesses) == 1 and weaknesses[0].get('aspect') == 'ì—†ìŒ'):
        md += f"### âœ¨ ì „ë°˜ì ìœ¼ë¡œ ì–‘í˜¸\n\n"
        md += f"ê³ ê° ë§Œì¡±ë„ê°€ ë†’ìœ¼ë©°, ì‹¤í–‰ ê°€ëŠ¥í•œ ì•½ì ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n"
        md += f"ê²½ìŸì‚¬ ëŒ€ë¹„ ìš°ìœ„ë¥¼ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.\n\n"
        md += f"ğŸ’¡ **ì „ëµ**: ê²½ìŸì‚¬ì˜ ì•½ì ì„ í™œìš©í•œ ì°¨ë³„í™”ì— ì§‘ì¤‘\n\n"
    else:
        for weakness in weaknesses:
            md += f"### {weakness.get('priority', 1)}. {weakness['aspect']}\n\n"
            
            if weakness.get('insight_framework'):
                md += f"**ğŸ¯ ì¸ì‚¬ì´íŠ¸ í”„ë ˆì„ì›Œí¬**: {weakness['insight_framework']}\n\n"
            
            md += f"{weakness['description']}\n\n"
            
            # í†µê³„ í‘œì‹œ
            if weakness.get('statistical_evidence'):
                md += f"**ğŸ“Š í†µê³„**: {weakness['statistical_evidence']}\n\n"
            
            # ì‹¤ì œ ë¦¬ë·°
            if weakness.get('sample_reviews'):
                md += "**ğŸ’¬ ì‹¤ì œ ë¦¬ë·°**:\n"
                for review in weakness['sample_reviews'][:3]:
                    md += f"- \"{review}\"\n"
                md += "\n"
            
            # ì°¸ê³  ì‚¬í•­
            if weakness.get('note'):
                md += f"ğŸ’¡ **ì°¸ê³ **: {weakness['note']}\n\n"
            
            # ì•¡ì…˜
            if weakness.get('action'):
                action = weakness['action']
                md += f"**ğŸ¬ ì¦‰ì‹œ ì•¡ì…˜ (2ì£¼ ëŸ¬ë‹)**\n"
                md += f"- **ì œëª©**: {action.get('title', '')}\n"
                md += f"- **ë°©ë²•**: {action.get('how', '')}\n"
                md += f"- **ë¹„ìš©**: {action.get('cost', '')}\n"
                md += f"- **ë‚œì´ë„**: {action.get('difficulty', '')}\n"
                if action.get('timeline'):
                    md += f"- **ê¸°ê°„**: {action['timeline']}\n"
                md += f"- **KPI**: {action.get('kpi', '')}\n"
            md += "\n"
    
    # 2. ìš°ë¦¬ì˜ ê°•ì 
    md += f"---\n\n## âœ… 2. ìš°ë¦¬ì˜ ìœ ì˜ë¯¸í•œ ê°•ì  (ìœ ì§€/í™•ëŒ€)\n\n"
    for strength in json_result.get('ìš°ë¦¬ì˜_ê°•ì ', []):
        md += f"### {strength['aspect']}\n\n"
        
        if strength.get('insight_framework'):
            md += f"**ğŸ¯ ì¸ì‚¬ì´íŠ¸ í”„ë ˆì„ì›Œí¬**: {strength['insight_framework']}\n\n"
        
        md += f"{strength['description']}\n\n"
        
        # í†µê³„ í‘œì‹œ
        if strength.get('statistical_evidence'):
            md += f"**ğŸ“Š í†µê³„**: {strength['statistical_evidence']}\n\n"
        
        # ì‹¤ì œ ë¦¬ë·°
        if strength.get('sample_reviews'):
            md += "**ğŸ’¬ ì‹¤ì œ ë¦¬ë·°**:\n"
            for review in strength['sample_reviews'][:2]:
                md += f"- \"{review}\"\n"
            md += "\n"
        
        # ë§ˆì¼€íŒ… íŒ (ì™„ì„± ë¬¸ì¥)
        if strength.get('marketing_tip'):
            md += f"**ğŸ“£ ë§ˆì¼€íŒ… ë©”ì‹œì§€**: {strength['marketing_tip']}\n\n"
        
        # ì•¡ì…˜
        if strength.get('action'):
            action = strength['action']
            md += f"**ğŸ¬ ì¦‰ì‹œ ì•¡ì…˜ (2ì£¼ ëŸ¬ë‹)**\n"
            md += f"- **ì œëª©**: {action.get('title', '')}\n"
            md += f"- **ë°©ë²•**: {action.get('how', '')}\n"
            if action.get('timeline'):
                md += f"- **ê¸°ê°„**: {action['timeline']}\n"
            md += f"- **KPI**: {action.get('kpi', '')}\n"
        
        md += "\n"
    
    # 3. ê²½ìŸì‚¬ì˜ ì•½ì  = ìš°ë¦¬ì˜ ê¸°íšŒ
    md += f"---\n\n## ğŸ’¡ 3. ê²½ìŸì‚¬ì˜ ì•½ì  = ìš°ë¦¬ì˜ ì°¨ë³„í™” ê¸°íšŒ\n\n"
    
    comp_opps = json_result.get('ê²½ìŸì‚¬ì˜_ì•½ì _ìš°ë¦¬ì˜_ê¸°íšŒ', [])
    if not comp_opps:
        md += "âš ï¸ ê²½ìŸì‚¬ ë¦¬ë·° ë¶„ì„ ê²°ê³¼ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. ë” ë§ì€ ê²½ìŸì‚¬ ë¦¬ë·° ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.\n\n"
    else:
        for opp in comp_opps:
            md += f"### ğŸ¯ {opp['aspect']}\n\n"
            md += f"{opp['description']}\n\n"
            
            # í†µê³„ í‘œì‹œ (ìˆìœ¼ë©´)
            if opp.get('statistical_evidence'):
                md += f"**ğŸ“Š í†µê³„**: {opp['statistical_evidence']}\n\n"
            
            md += f"**ğŸ’¡ ê¸°íšŒ**: {opp.get('opportunity', '')}\n"
            if opp.get('marketing_message'):
                md += f"**ğŸ“£ ë§ˆì¼€íŒ… ë©”ì‹œì§€**: \"{opp['marketing_message']}\"\n"
            
            # ê²½ìŸì‚¬ ë¦¬ë·° ìƒ˜í”Œ (ìˆìœ¼ë©´)
            if opp.get('sample_comp_reviews'):
                md += "\n**ê²½ìŸì‚¬ ë¦¬ë·° ì˜ˆì‹œ**:\n"
                for review in opp['sample_comp_reviews'][:2]:
                    md += f"- {review}\n"
            
            md += "\n"
    
    # 4. ê²½ìŸì‚¬ì˜ ê°•ì  = ë°°ìš¸ ì 
    md += f"---\n\n## ğŸ“š 4. ê²½ìŸì‚¬ì˜ ê°•ì  = ìš°ë¦¬ê°€ ë²¤ì¹˜ë§ˆí‚¹í•  ì \n\n"
    
    comp_benchs = json_result.get('ê²½ìŸì‚¬ì˜_ê°•ì _ë°°ìš¸ì ', [])
    if not comp_benchs:
        md += "âš ï¸ ê²½ìŸì‚¬ ë¦¬ë·° ë¶„ì„ ê²°ê³¼ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. ë” ë§ì€ ê²½ìŸì‚¬ ë¦¬ë·° ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.\n\n"
    else:
        for bench in comp_benchs:
            md += f"### ğŸ” {bench['aspect']}\n\n"
            
            if bench.get('insight_framework'):
                md += f"**ğŸ¯ ì¸ì‚¬ì´íŠ¸ í”„ë ˆì„ì›Œí¬**: {bench['insight_framework']}\n\n"
            
            md += f"{bench['description']}\n\n"
            
            # í†µê³„ í‘œì‹œ (ìˆìœ¼ë©´)
            if bench.get('statistical_evidence'):
                md += f"**ğŸ“Š í†µê³„**: {bench['statistical_evidence']}\n\n"
            
            md += f"**ğŸ“‹ ë²¤ì¹˜ë§ˆí¬**: {bench.get('benchmark', '')}\n"
            md += f"**ğŸ¬ ì‹¤í–‰ ê³„íš**: {bench.get('action_plan', '')}\n"
            
            # ê²½ìŸì‚¬ ë¦¬ë·° ìƒ˜í”Œ (ìˆìœ¼ë©´)
            if bench.get('sample_comp_reviews'):
                md += "\n**ê²½ìŸì‚¬ ë¦¬ë·° ì˜ˆì‹œ**:\n"
                for review in bench['sample_comp_reviews'][:2]:
                    md += f"- {review}\n"
            
            md += "\n"
    
    # ì•¡ì…˜ ì•„ì´í…œ
    md += f"---\n\n## ğŸ¬ ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥í•œ ì•¡ì…˜ í”Œëœ (2ì£¼ ëŸ¬ë‹)\n\n"
    for i, action in enumerate(json_result.get('action_items', []), 1):
        md += f"### ì•¡ì…˜ {i}: {action.get('title', 'ì œëª© ì—†ìŒ')}\n\n"
        md += f"**ğŸ“‚ ì¹´í…Œê³ ë¦¬**: {action.get('category', 'ë¯¸ë¶„ë¥˜')}\n\n"
        if action.get('why'):
            md += f"**â“ ì™œ í•„ìš”í•œê°€?**\n{action['why']}\n\n"
        if action.get('how'):
            md += f"**ğŸ”§ ì–´ë–»ê²Œ ì‹¤í–‰?**\n{action['how']}\n\n"
        md += f"**ğŸ’° ë¹„ìš©**: {action.get('cost', 'ë¯¸ì •')}\n"
        md += f"**ğŸ¯ ë‚œì´ë„**: {action.get('difficulty', 'ë³´í†µ')}\n"
        if action.get('timeline'):
            md += f"**â±ï¸ ê¸°ê°„**: {action['timeline']}\n"
        md += f"**ğŸ“Š KPI**: {action.get('kpi', 'ë¯¸ì •')}\n\n"
    
    # ê²½ìŸì‚¬ ëª©ë¡ (ëª…ì¹­ ì •ë¦¬)
    md += f"---\n\n## ğŸ“Œ ê²½ìŸì‚¬ ëª©ë¡\n\n"
    for i, comp in enumerate(competitors, 1):
        # ëª…ì¹­ ì •ë¦¬: "ë¸Œëœë“œì¹´í…Œê³ ë¦¬,ì¹´í…Œê³ ë¦¬2" â†’ "ë¸Œëœë“œ (ì¹´í…Œê³ ë¦¬Â·ì¹´í…Œê³ ë¦¬2)"
        comp_name = comp.name
        comp_district = comp.district
        
        # ì¹´í…Œê³ ë¦¬ ë¶„ë¦¬ ì²˜ë¦¬
        if ',' in comp_name:
            parts = comp_name.split(',')
            if len(parts) > 1:
                # ì²« ë²ˆì§¸ê°€ ë¸Œëœë“œëª…, ë‚˜ë¨¸ì§€ê°€ ì¹´í…Œê³ ë¦¬
                brand = parts[0]
                categories = ' Â· '.join(parts[1:])
                comp_name = f"{brand} ({categories})"
        
        md += f"{i}. **{comp_name}** - {comp_district} - {comp.review_count}ê°œ ë¦¬ë·°\n"
    
    # ê²½ìŸì‚¬ ì„ ì • ë¡œì§ ë°•ìŠ¤ ì¶”ê°€
    if strategy_detail:
        md += strategy_detail
    
    # ë©”íƒ€ë°ì´í„°
    md += f"""
---

## ğŸ“Š ë¶„ì„ ë©”íƒ€ë°ì´í„°

### ê¸°ë³¸ ì •ë³´
- **ë¶„ì„ ëª¨ë¸**: GPT-4o (temperature=0.0, í• ë£¨ì‹œë„¤ì´ì…˜ ë°©ì§€)
- **ë¶„ì„ ì¼ì‹œ**: {timestamp}
- **ë°ì´í„° ê¸°ê°„**: ìµœê·¼ 6ê°œì›”
- **ìš°ë¦¬ ë¦¬ë·° ìˆ˜**: {len(target_reviews)}ê°œ
- **ê²½ìŸì‚¬ ìˆ˜**: {len(competitors)}ê°œ
- **ë¶„ì„ ë°©ì‹**: í†µê³„ì  ìœ ì˜ì„± + 4ë‹¨ê³„ ë¶„ë¥˜ + 9ê°€ì§€ ì¸ì‚¬ì´íŠ¸ í”„ë ˆì„ì›Œí¬

### í†µê³„ í‘œê¸° í˜•ì‹
ëª¨ë“  í†µê³„ëŠ” ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤:
- **í˜•ì‹**: "ìš°ë¦¬ X.X%(n=N1) vs ê²½ìŸì‚¬ Y.Y%(n=N2); GAP Â±Z.Z%p; 95% CI [L, U]; P=0.XX ğŸŸ¢"
- **n**: í‘œë³¸ ìˆ˜ (ì „ì²´ ë¦¬ë·° ì¤‘ í•´ë‹¹ í‚¤ì›Œë“œ ì–¸ê¸‰ ê°€ëŠ¥ ë¦¬ë·° ìˆ˜)
- **GAP**: ìš°ë¦¬ì™€ ê²½ìŸì‚¬ì˜ ì°¨ì´ (%p = percentage point)
- **95% CI**: 95% ì‹ ë¢°êµ¬ê°„ (ì°¨ì´ì˜ ë¶ˆí™•ì‹¤ì„± ë²”ìœ„)
- **P**: P-value (í†µê³„ì  ìœ ì˜ì„±, P<0.05ë©´ ìœ ì˜ë¯¸)

### ì‹ ë¢° ë°°ì§€ ì˜ë¯¸
- ğŸŸ¢ **ë†’ì€ ì‹ ë¢°ë„**: í‘œë³¸ ì¶©ë¶„(nâ‰¥100) & CI ì¢ìŒ(<0.15) & í†µê³„ì  ìœ ì˜(P<0.05)
- ğŸŸ¡ **ê²½ê³„ ì‹ ë¢°ë„**: P-valueê°€ 0.05~0.10 (ìœ ì˜ë¯¸í•  ê°€ëŠ¥ì„±)
- âšªï¸ **ì°¸ê³ ìš©**: í‘œë³¸ ë¶€ì¡±(n<50) ë˜ëŠ” í†µê³„ì ìœ¼ë¡œ ìœ ì˜í•˜ì§€ ì•ŠìŒ

### 9ê°€ì§€ ê²€ì¦ëœ ì¸ì‚¬ì´íŠ¸ í”„ë ˆì„ì›Œí¬
1. **ëŒ€ê¸°(ì›¨ì´íŒ…) ì–¸ê¸‰ë¥ **: ë‚®ìœ¼ë©´ ê³§ ê¸°íšŒ â†’ ë¹ ë¥¸ ì…ì¥ ë©”ì‹œì§€
2. **ì¬ë°©ë¬¸ ì˜í–¥ ì‹œê·¸ë„**: ì‘ì•„ë„ ê°•ë ¥ â†’ ì¶©ì„±ë„ ë£¨í”„ ì„¤ê³„
3. **ë§›ì˜ ë°©í–¥ì„±**: ì·¨í–¥ ì¢Œí‘œ â†’ ì˜µì…˜ ëª…ì‹œ
4. **ì‹œê·¸ë‹ˆì²˜ ë‹¨ì¼í™”**: ëŒ€í‘œ ë©”ë‰´ ì „ë©´ ë°°ì¹˜
5. **ì˜¨ë„/ì‹ê° í´ë ˆì„**: ì¦‰ì‹œ í•˜ë“œí”½ìŠ¤
6. **í”¼í¬íƒ€ì„ ì„œë¹„ìŠ¤ í¸ì°¨**: ì¸ë ¥/ë™ì„  ê°œì„ 
7. **ë¶„ìœ„ê¸°/ê³µê°„ í‚¤ì›Œë“œ**: ëˆ ë˜ëŠ” ì“°ì„ìƒˆ â†’ UGC ìœ ë„
8. **ê°€ê²© ë¶ˆë§Œ**: êµ¬ì„± ë¬¸ì œ â†’ ì•µì»¤ ê°€ê²© ì„¸íŒ…
9. **ê²½ìŸì‚¬ ê°•ì **: ë¼ì´íŠ¸ ë²¤ì¹˜ â†’ 2ì£¼ íŒŒì¼ëŸ¿

### 4ë‹¨ê³„ ë¶„ë¥˜
1. ğŸ”¥ **ìš°ë¦¬ì˜ ì•½ì ** â†’ ì¦‰ì‹œ ê°œì„  (P<0.05 & GAP<-0.10)
2. âœ… **ìš°ë¦¬ì˜ ê°•ì ** â†’ ìœ ì§€/í™•ëŒ€ (P<0.05 & GAP>+0.10)
3. ğŸ’¡ **ê²½ìŸì‚¬ì˜ ì•½ì ** â†’ ì°¨ë³„í™” ê¸°íšŒ (ë§ˆì¼€íŒ… í¬ì¸íŠ¸)
4. ğŸ“š **ê²½ìŸì‚¬ì˜ ê°•ì ** â†’ ë²¤ì¹˜ë§ˆí‚¹ ëŒ€ìƒ (2ì£¼ íŒŒì¼ëŸ¿)

### ê²€ì¦ í”„ë¡œì„¸ìŠ¤ (6ë‹¨ê³„)
1. ìƒ˜í”Œ ë¦¬ë·° ëª©ë¡ ì¬í™•ì¸
2. í‚¤ì›Œë“œë¡œ ì°¾ê¸°
3. ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ë¬¸ì¥ ì°¾ê¸°
4. ë¦¬ë·° ë²ˆí˜¸ì™€ í•¨ê»˜ ì›ë¬¸ ê·¸ëŒ€ë¡œ ë³µì‚¬
5. ìê¸° ê²€ì¦ (100% í™•ì‹ )
6. ê°œìˆ˜ í™•ì¸ + ìŠ¤ì¼€ì¼ ë§ì¶”ê¸° (ë¹„ìœ¨ ê¸°ë°˜)

### ì‹¤í–‰ ê°€ëŠ¥ì„± í•„í„°
- âœ… **í¬í•¨**: ë§›/ì„œë¹„ìŠ¤/ê°€ê²©/ì²­ê²°/ë©”ë‰´/ëŒ€ê¸°/ì¬ë°©ë¬¸/ì˜¨ë„
- âŒ **ì œì™¸**: ì£¼ì°¨/ê±´ë¬¼í¬ê¸°/ìœ„ì¹˜/ì†ŒìŒ(ê±´ë¬¼êµ¬ì¡°)/ê³„ë‹¨/ì—˜ë¦¬ë² ì´í„°
- **ê¸°ì¤€**: ì‚¬ì¥ë‹˜ì´ 3ê°œì›” ë‚´ í•´ê²° ê°€ëŠ¥í•œ ê²ƒë§Œ
"""
    
    return md